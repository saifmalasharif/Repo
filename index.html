<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TB Care · Ninawa</title>
<style>
/* ── SYSTEM FONTS — no external load ── */
:root {
  --bg: #f2f4f7;
  --surface: #fff;
  --surface2: #f8f9fb;
  --border: #e3e7ed;
  --accent: #1a5c3e;
  --accent-light: #eaf4ee;
  --phase1: #d97706;
  --phase1-light: #fef3c7;
  --phase2: #2563eb;
  --phase2-light: #dbeafe;
  --danger: #dc2626;
  --danger-light: #fee2e2;
  --warn: #d97706;
  --warn-light: #fef3c7;
  --ok: #16a34a;
  --ok-light: #dcfce7;
  --text: #111827;
  --text2: #4b5563;
  --text3: #9ca3af;
  --mono: ui-monospace, 'Courier New', monospace;
  --sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  --radius: 14px;
  --shadow: 0 1px 3px rgba(0,0,0,.08), 0 8px 24px rgba(0,0,0,.06);
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body { font-family: var(--sans); background: var(--bg); color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased; }

/* LOGIN */
#login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(160deg,#0b2418 0%,#1a5c3e 55%,#23895c 100%); padding: 20px; }
.login-card { background: #fff; border-radius: 22px; padding: 40px 36px; width: 100%; max-width: 390px; box-shadow: 0 32px 80px rgba(0,0,0,.28); }
.login-mark { display: flex; align-items: center; gap: 11px; margin-bottom: 26px; }
.login-mark-icon { width: 44px; height: 44px; background: var(--accent); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.login-mark-icon svg { width: 24px; height: 24px; fill: white; }
.lm-title { font-size: 17px; font-weight: 700; }
.lm-sub { font-size: 11px; color: var(--text2); margin-top: 1px; letter-spacing: .04em; }
.tab-row { display: flex; gap: 3px; background: var(--bg); border-radius: 10px; padding: 3px; margin-bottom: 24px; }
.tab-btn { flex: 1; padding: 9px; border: none; background: transparent; border-radius: 8px; font-family: var(--sans); font-size: 13px; font-weight: 500; cursor: pointer; color: var(--text2); transition: all .18s; }
.tab-btn.active { background: #fff; color: var(--accent); box-shadow: 0 1px 4px rgba(0,0,0,.1); font-weight: 700; }
.field { margin-bottom: 13px; }
.field label { display: block; font-size: 11px; font-weight: 600; color: var(--text2); margin-bottom: 5px; letter-spacing: .06em; text-transform: uppercase; }
.field input { width: 100%; padding: 11px 13px; border: 1.5px solid var(--border); border-radius: 9px; font-family: var(--sans); font-size: 15px; color: var(--text); background: var(--surface2); outline: none; -webkit-appearance: none; }
.field input:focus { border-color: var(--accent); background: #fff; }
.btn-primary { width: 100%; padding: 14px; background: var(--accent); color: #fff; border: none; border-radius: 10px; font-family: var(--sans); font-size: 15px; font-weight: 700; cursor: pointer; margin-top: 6px; -webkit-appearance: none; }
.login-error { color: var(--danger); font-size: 12px; margin-top: 10px; text-align: center; display: none; padding: 8px; background: var(--danger-light); border-radius: 8px; }

/* APP */
#app { display: none; min-height: 100vh; }
#admin-view, #patient-view { display: none; }

/* TOPBAR */
.topbar { background: #fff; border-bottom: 1px solid var(--border); padding: 0 18px; height: 56px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
.topbar-brand { display: flex; align-items: center; gap: 9px; }
.topbar-icon { width: 30px; height: 30px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
.topbar-icon svg { width: 17px; height: 17px; fill: white; }
.topbar-title { font-size: 15px; font-weight: 700; }
.topbar-sub { font-size: 10px; color: var(--text2); letter-spacing: .04em; }
.topbar-right { display: flex; align-items: center; gap: 8px; }
.chip { font-size: 11px; font-family: var(--mono); background: var(--accent-light); color: var(--accent); padding: 4px 10px; border-radius: 20px; font-weight: 600; }
.btn-ghost { padding: 7px 12px; border: 1.5px solid var(--border); background: #fff; border-radius: 8px; font-family: var(--sans); font-size: 12px; font-weight: 500; cursor: pointer; color: var(--text2); }

/* CONTENT */
.admin-content { padding: 16px; max-width: 1100px; margin: 0 auto; }

/* STATS */
.stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }
@media(min-width:600px){ .stats-grid { grid-template-columns: repeat(6,1fr); } }
.stat-card { background: #fff; border-radius: var(--radius); padding: 14px 16px; border: 1px solid var(--border); }
.stat-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: .06em; color: var(--text3); margin-bottom: 6px; }
.stat-val { font-size: 26px; font-weight: 700; font-family: var(--mono); line-height: 1; }
.stat-val.green { color: var(--ok); }
.stat-val.amber { color: var(--warn); }
.stat-val.red { color: var(--danger); }
.stat-val.blue { color: var(--phase2); }

/* ALERTS */
.alerts-banner { margin-bottom: 14px; display: none; }
.alert-item { display: flex; align-items: flex-start; gap: 9px; background: var(--danger-light); border: 1px solid #fca5a5; border-radius: 10px; padding: 10px 13px; margin-bottom: 6px; font-size: 13px; color: #7f1d1d; cursor: pointer; }
.alert-item.warn { background: var(--warn-light); border-color: #fcd34d; color: #78350f; }
.alert-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--danger); flex-shrink: 0; margin-top: 4px; }
.alert-dot.warn { background: var(--warn); }

/* MAP CARD */
.map-card { background: #fff; border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; box-shadow: var(--shadow); margin-bottom: 16px; }
.map-header { padding: 13px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
.map-header h3 { font-size: 14px; font-weight: 700; }
.map-header p { font-size: 11px; color: var(--text2); margin-top: 1px; }
.map-legend { display: flex; gap: 12px; flex-wrap: wrap; }
.legend-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--text2); }
.legend-dot { width: 10px; height: 10px; border-radius: 50%; }
.map-body { display: flex; flex-direction: column; }
@media(min-width:700px){ .map-body { flex-direction: row; } }
#svg-map-wrap { flex: 1; min-height: 300px; background: #e8f0e9; position: relative; overflow: hidden; }
#svg-map-wrap svg { width: 100%; height: 100%; display: block; }
.district-sidebar { width: 100%; border-top: 1px solid var(--border); overflow-y: auto; max-height: 300px; }
@media(min-width:700px){ .district-sidebar { width: 220px; border-top: none; border-left: 1px solid var(--border); max-height: 380px; } }
.dist-row { display: flex; align-items: center; justify-content: space-between; padding: 9px 13px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background .1s; font-size: 13px; }
.dist-row:hover { background: var(--accent-light); }
.dist-row:last-child { border-bottom: none; }
.dist-name { font-weight: 500; }
.dist-bar-wrap { flex: 1; margin: 0 8px; height: 4px; background: var(--border); border-radius: 99px; overflow: hidden; }
.dist-bar { height: 100%; border-radius: 99px; }
.dist-count { font-family: var(--mono); font-size: 11px; font-weight: 700; min-width: 28px; text-align: right; }
.map-empty { padding: 32px 16px; text-align: center; color: var(--text3); font-size: 13px; }

/* TABLE */
.table-card { background: #fff; border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; box-shadow: var(--shadow); }
.table-toolbar { padding: 12px 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
.search-wrap { position: relative; flex: 1; min-width: 160px; max-width: 280px; }
.search-wrap input { width: 100%; padding: 9px 12px 9px 32px; border: 1.5px solid var(--border); border-radius: 8px; font-family: var(--sans); font-size: 13px; outline: none; background: var(--surface2); -webkit-appearance: none; }
.search-wrap input:focus { border-color: var(--accent); }
.search-icon { position: absolute; left: 9px; top: 50%; transform: translateY(-50%); opacity: .4; }
.toolbar-right { display: flex; gap: 7px; align-items: center; flex-wrap: wrap; }
.filter-sel { padding: 8px 9px; border: 1.5px solid var(--border); border-radius: 8px; font-family: var(--sans); font-size: 12px; background: var(--surface2); color: var(--text2); outline: none; cursor: pointer; -webkit-appearance: none; }
.btn-accent { padding: 9px 15px; background: var(--accent); color: #fff; border: none; border-radius: 9px; font-family: var(--sans); font-size: 13px; font-weight: 700; cursor: pointer; white-space: nowrap; }

table { width: 100%; border-collapse: collapse; }
thead th { padding: 9px 14px; text-align: left; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; color: var(--text3); background: var(--surface2); border-bottom: 1px solid var(--border); white-space: nowrap; }
tbody tr { border-bottom: 1px solid var(--border); cursor: pointer; transition: background .1s; }
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: var(--accent-light); }
tbody td { padding: 11px 14px; font-size: 13px; }
.code-tag { font-family: var(--mono); font-size: 11px; background: var(--surface2); border: 1px solid var(--border); padding: 3px 7px; border-radius: 5px; }
.pill { display: inline-flex; align-items: center; padding: 3px 9px; border-radius: 20px; font-size: 11px; font-weight: 700; white-space: nowrap; }
.pill.phase1 { background: var(--phase1-light); color: #92400e; }
.pill.phase2 { background: var(--phase2-light); color: #1e40af; }
.pill.pdone { background: var(--ok-light); color: #166534; }
.pill.med-ok { background: var(--ok-light); color: #166534; }
.pill.med-low { background: var(--warn-light); color: #92400e; }
.pill.med-crit { background: var(--danger-light); color: #991b1b; }
.pill.neutral { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); }
.empty-state { text-align: center; padding: 48px 20px; color: var(--text3); font-size: 13px; }

/* PANEL */
.panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.35); z-index: 140; display: none; }
.detail-panel { position: fixed; right: 0; top: 0; bottom: 0; width: min(460px, 100vw); background: #fff; border-left: 1px solid var(--border); z-index: 150; transform: translateX(100%); transition: transform .26s ease; display: flex; flex-direction: column; overflow: hidden; }
.detail-panel.open { transform: translateX(0); }
.panel-header { padding: 16px 20px; border-bottom: 1px solid var(--border); }
.panel-htop { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 9px; }
.panel-name { font-size: 17px; font-weight: 700; }
.panel-meta { display: flex; gap: 5px; flex-wrap: wrap; }
.panel-close { width: 30px; height: 30px; border: none; background: var(--bg); border-radius: 7px; cursor: pointer; font-size: 16px; color: var(--text2); flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
.timeline-wrap { padding: 13px 20px; border-bottom: 1px solid var(--border); background: var(--surface2); }
.tl-label { display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; margin-bottom: 6px; }
.tl-track { height: 12px; background: var(--border); border-radius: 99px; overflow: hidden; display: flex; }
.tl-p1 { height: 100%; background: var(--phase1); }
.tl-p2 { height: 100%; background: var(--phase2); }
.tl-months { display: flex; justify-content: space-between; margin-top: 4px; }
.tl-months span { font-size: 10px; color: var(--text3); }
.tl-info { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 7px; margin-top: 9px; }
.tl-block { border-radius: 8px; padding: 7px 9px; text-align: center; }
.tl-block .tv { font-size: 15px; font-weight: 700; font-family: var(--mono); }
.tl-block .tl { font-size: 10px; color: var(--text2); margin-top: 1px; text-transform: uppercase; }
.panel-body { padding: 16px 20px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
.info-section { margin-bottom: 18px; }
.info-section-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; color: var(--text3); margin-bottom: 9px; }
.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border); border-radius: 10px; overflow: hidden; border: 1px solid var(--border); }
.info-cell { background: #fff; padding: 9px 12px; }
.info-cell.full { grid-column: 1/-1; }
.info-key { font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: .05em; margin-bottom: 2px; }
.info-val { font-size: 13px; font-weight: 500; }
.med-tracker { background: var(--surface2); border-radius: 11px; padding: 13px 15px; border: 1px solid var(--border); }
.med-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 9px; }
.med-count { font-size: 24px; font-weight: 700; font-family: var(--mono); }
.med-sub { font-size: 11px; color: var(--text2); margin-top: 1px; }
.med-bar-track { height: 8px; background: var(--border); border-radius: 99px; overflow: hidden; margin-bottom: 7px; }
.med-bar-fill { height: 100%; border-radius: 99px; }
.med-bar-fill.ok { background: var(--ok); }
.med-bar-fill.warn { background: var(--warn); }
.med-bar-fill.danger { background: var(--danger); }
.med-stats { display: flex; gap: 10px; font-size: 11px; color: var(--text2); flex-wrap: wrap; }
.med-alert { display: flex; gap: 7px; align-items: flex-start; border-radius: 9px; padding: 9px 11px; font-size: 12px; margin-top: 9px; line-height: 1.5; }
.med-alert.ok { background: var(--ok-light); color: #14532d; }
.med-alert.warn { background: var(--warn-light); color: #78350f; }
.med-alert.danger { background: var(--danger-light); color: #7f1d1d; }
.update-row { display: flex; gap: 7px; align-items: center; margin-top: 12px; }
.update-row input { flex: 1; padding: 9px 11px; border: 1.5px solid var(--border); border-radius: 8px; font-family: var(--mono); font-size: 14px; outline: none; -webkit-appearance: none; }
.update-row input:focus { border-color: var(--accent); }
.btn-sm { padding: 9px 13px; border-radius: 8px; font-family: var(--sans); font-size: 12px; font-weight: 700; cursor: pointer; border: none; }
.btn-sm.green { background: var(--accent); color: #fff; }
.btn-sm.red { background: var(--danger-light); color: var(--danger); }
.btn-sm.gray { background: var(--bg); color: var(--text2); border: 1px solid var(--border); }
.panel-footer { padding: 12px 20px; border-top: 1px solid var(--border); display: flex; gap: 7px; background: var(--surface2); }

/* MODAL */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.45); display: none; align-items: flex-end; justify-content: center; z-index: 200; }
@media(min-width:600px){ .modal-overlay { align-items: center; padding: 20px; } }
.modal { background: #fff; border-radius: 20px 20px 0 0; width: 100%; max-width: 580px; max-height: 94vh; overflow-y: auto; -webkit-overflow-scrolling: touch; box-shadow: 0 -8px 40px rgba(0,0,0,.2); }
@media(min-width:600px){ .modal { border-radius: 20px; max-height: 92vh; box-shadow: 0 40px 100px rgba(0,0,0,.3); } }
.modal-header { padding: 20px 24px 0; display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
.modal-header h2 { font-size: 17px; font-weight: 700; }
.modal-close { width: 30px; height: 30px; border: none; background: var(--bg); border-radius: 7px; cursor: pointer; font-size: 16px; color: var(--text2); }
.modal-body { padding: 0 24px 32px; }
.form-section { margin-bottom: 16px; }
.form-section-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; color: var(--text3); margin-bottom: 9px; padding-bottom: 7px; border-bottom: 1px solid var(--border); }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 11px; }
.form-grid .full { grid-column: 1/-1; }
.form-field label { display: block; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .05em; color: var(--text2); margin-bottom: 4px; }
.form-field input, .form-field select { width: 100%; padding: 10px 11px; border: 1.5px solid var(--border); border-radius: 9px; font-family: var(--sans); font-size: 14px; outline: none; background: var(--surface2); color: var(--text); -webkit-appearance: none; }
.form-field input:focus, .form-field select:focus { border-color: var(--accent); background: #fff; }
.hint { font-size: 11px; color: var(--text3); margin-top: 3px; }
.modal-footer { display: flex; gap: 9px; justify-content: flex-end; border-top: 1px solid var(--border); margin-top: 16px; padding-top: 16px; }
.btn-cancel { padding: 10px 16px; background: var(--bg); border: none; border-radius: 8px; font-family: var(--sans); font-size: 13px; font-weight: 500; cursor: pointer; color: var(--text2); }

/* PATIENT VIEW */
.patient-topbar { background: var(--accent); padding: 0 20px; height: 56px; display: flex; align-items: center; justify-content: space-between; }
.pt-tb-left span { color: #fff; font-weight: 700; font-size: 15px; display: block; }
.pt-tb-left small { color: rgba(255,255,255,.6); font-size: 11px; font-family: var(--mono); }
.pt-logout { background: rgba(255,255,255,.18); color: #fff; border: none; padding: 7px 12px; border-radius: 7px; font-size: 12px; cursor: pointer; font-weight: 600; }
.pt-content { padding: 16px; max-width: 500px; margin: 0 auto; }
.pt-card { background: #fff; border-radius: var(--radius); border: 1px solid var(--border); padding: 18px; margin-bottom: 12px; box-shadow: var(--shadow); }
.pt-card h2 { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; color: var(--text3); margin-bottom: 12px; }
.pt-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
.pt-row:last-child { border-bottom: none; }
.pt-row-key { color: var(--text2); }
.pt-row-val { font-weight: 600; }
.ring-wrap { display: flex; align-items: center; gap: 16px; }
.ring-svg { width: 84px; height: 84px; flex-shrink: 0; }
.ring-bg { fill: none; stroke: var(--border); stroke-width: 9; }
.ring-fill { fill: none; stroke-width: 9; stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; }
.ring-text { text-anchor: middle; dominant-baseline: middle; font-family: var(--mono); font-size: 13px; font-weight: 700; fill: var(--text); }
.ring-info h3 { font-size: 20px; font-weight: 700; font-family: var(--mono); }
.ring-info p { font-size: 12px; color: var(--text2); margin-top: 2px; }
.ring-info .wk { font-size: 13px; font-weight: 700; color: var(--accent); margin-top: 5px; }
.pt-tl-track { height: 10px; background: var(--border); border-radius: 99px; display: flex; overflow: hidden; margin-bottom: 7px; }
.pt-tl-p1 { background: var(--phase1); height: 100%; }
.pt-tl-p2 { background: var(--phase2); height: 100%; }
.pt-tl-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--text3); }
.pt-phase-blocks { display: grid; grid-template-columns: 1fr 1fr; gap: 9px; margin-top: 11px; }
.pt-phase-block { border-radius: 10px; padding: 11px 13px; }
.pb-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .05em; margin-bottom: 4px; }
.pb-med { font-size: 15px; font-weight: 700; font-family: var(--mono); }
.pb-sub { font-size: 11px; margin-top: 2px; opacity: .8; }

/* Mobile table hide columns */
@media(max-width:600px){
  thead th:nth-child(3),tbody td:nth-child(3),
  thead th:nth-child(5),tbody td:nth-child(5),
  thead th:nth-child(7),tbody td:nth-child(7){ display:none; }
  .form-grid { grid-template-columns: 1fr; }
  .form-grid .full { grid-column: 1; }
}

/* Tooltip on SVG map */
.map-tooltip { position: absolute; background: rgba(17,24,39,.9); color: #fff; font-size: 12px; padding: 6px 10px; border-radius: 7px; pointer-events: none; display: none; z-index: 10; white-space: nowrap; line-height: 1.5; }
</style>
</head>
<body>

<!-- ═══ LOGIN ═══ -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-mark">
      <div class="login-mark-icon"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z"/></svg></div>
      <div><div class="lm-title">TB Care Program</div><div class="lm-sub">NINAWA · HEALTH DIRECTORATE</div></div>
    </div>
    <div class="tab-row">
      <button class="tab-btn active" onclick="setTab('admin')">Admin</button>
      <button class="tab-btn" onclick="setTab('patient')">Patient</button>
    </div>
    <div id="admin-login-form">
      <div class="field"><label>Username</label><input type="text" id="admin-user" placeholder="admin" autocomplete="off" autocapitalize="none"></div>
      <div class="field"><label>Password</label><input type="password" id="admin-pass" placeholder="••••••••"></div>
      <button class="btn-primary" onclick="adminLogin()">Sign In</button>
    </div>
    <div id="patient-login-form" style="display:none">
      <div class="field"><label>Patient Code</label><input type="text" id="pt-code-inp" placeholder="e.g. NNW-081" autocomplete="off" style="font-family:var(--mono);letter-spacing:.06em"></div>
      <button class="btn-primary" onclick="patientLogin()">Access My Records</button>
    </div>
    <div class="login-error" id="login-error">Incorrect credentials. Please try again.</div>
  </div>
</div>

<!-- ═══ APP ═══ -->
<div id="app">

<!-- ADMIN -->
<div id="admin-view">
  <div class="topbar">
    <div class="topbar-brand">
      <div class="topbar-icon"><svg viewBox="0 0 24 24" fill="white"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z"/></svg></div>
      <div><div class="topbar-title">TB Care · Ninawa</div><div class="topbar-sub">ADMIN DASHBOARD</div></div>
    </div>
    <div class="topbar-right">
      <span class="chip">SAIF</span>
      <button class="btn-ghost" onclick="logout()">Logout</button>
    </div>
  </div>
  <div class="admin-content">
    <div class="stats-grid" id="stats-grid"></div>
    <div class="alerts-banner" id="alerts-banner"></div>

    <!-- SVG MAP -->
    <div class="map-card">
      <div class="map-header">
        <div><h3>District TB Distribution · Ninawa</h3><p>Active cases by sector — tap a district to filter</p></div>
        <div class="map-legend">
          <div class="legend-item"><div class="legend-dot" style="background:#dc2626"></div>High (5+)</div>
          <div class="legend-item"><div class="legend-dot" style="background:#d97706"></div>Med (2–4)</div>
          <div class="legend-item"><div class="legend-dot" style="background:#16a34a"></div>Low (1)</div>
        </div>
      </div>
      <div class="map-body">
        <div id="svg-map-wrap">
          <svg id="ninawa-svg" viewBox="0 0 500 380" xmlns="http://www.w3.org/2000/svg" style="cursor:pointer">
            <!-- Background -->
            <rect width="500" height="380" fill="#dde8dd"/>
            <!-- Ninawa border shape (approximate outline) -->
            <path d="M60,50 L160,30 L260,20 L360,40 L440,80 L460,140 L450,200 L440,260 L400,320 L340,350 L260,360 L180,350 L110,320 L70,270 L50,200 L45,140 Z" fill="#c8dbc8" stroke="#9ab89a" stroke-width="2"/>
            <!-- River Tigris (approximate) -->
            <path d="M200,25 Q220,60 210,100 Q200,140 215,180 Q225,210 220,250 Q215,280 230,320" fill="none" stroke="#7ab3d4" stroke-width="4" stroke-linecap="round" opacity=".7"/>

            <!-- District regions (clickable) -->
            <!-- Mosul - center -->
            <ellipse id="dist-Mosul" cx="215" cy="155" rx="52" ry="44" fill="#c8dbc8" stroke="#9ab89a" stroke-width="1.5" class="dist-shape" data-district="Mosul"/>
            <text x="215" y="152" text-anchor="middle" font-size="10" fill="#1a3a1a" font-family="sans-serif" font-weight="600" pointer-events="none">Mosul</text>

            <!-- Tilkaif - north of Mosul -->
            <ellipse id="dist-Tilkaif" cx="230" cy="90" rx="38" ry="30" fill="#c8dbc8" stroke="#9ab89a" stroke-width="1.5" class="dist-shape" data-district="Tilkaif"/>
            <text x="230" y="87" text-anchor="middle" font-size="9" fill="#1a3a1a" font-family="sans-serif" font-weight="600" pointer-events="none">Tilkaif</text>

            <!-- Shekhan - northeast -->
            <ellipse id="dist-Shekhan" cx="340" cy="90" rx="38" ry="30" fill="#c8dbc8" stroke="#9ab89a" stroke-width="1.5" class="dist-shape" data-district="Shekhan"/>
            <text x="340" y="87" text-anchor="middle" font-size="9" fill="#1a3a1a" font-family="sans-serif" font-weight="600" pointer-events="none">Shekhan</text>

            <!-- Tal Afar - west -->
            <ellipse id="dist-TalAfar" cx="110" cy="160" rx="40" ry="32" fill="#c8dbc8" stroke="#9ab89a" stroke-width="1.5" class="dist-shape" data-district="Tal Afar"/>
            <text x="110" y="157" text-anchor="middle" font-size="9" fill="#1a3a1a" font-family="sans-serif" font-weight="600" pointer-events="none">Tal Afar</text>

            <!-- Hamdaniya - east of Mosul -->
            <ellipse id="dist-Hamdaniya" cx="340" cy="170" rx="42" ry="30" fill="#c8dbc8" stroke="#9ab89a" stroke-width="1.5" class="dist-shape" data-district="Hamdaniya"/>
            <text x="340" y="167" text-anchor="middle" font-size="9" fill="#1a3a1a" font-family="sans-serif" font-weight="600" pointer-events="none">Hamdaniya</text>

            <!-- Sinjar - southwest -->
            <ellipse id="dist-Sinjar" cx="105" cy="250" rx="44" ry="32" fill="#c8dbc8" stroke="#9ab89a" stroke-width="1.5" class="dist-shape" data-district="Sinjar"/>
            <text x="105" y="247" text-anchor="middle" font-size="9" fill="#1a3a1a" font-family="sans-serif" font-weight="600" pointer-events="none">Sinjar</text>

            <!-- Rabia - northwest -->
            <ellipse id="dist-Rabia" cx="150" cy="60" rx="36" ry="26" fill="#c8dbc8" stroke="#9ab89a" stroke-width="1.5" class="dist-shape" data-district="Rabia"/>
            <text x="150" y="58" text-anchor="middle" font-size="9" fill="#1a3a1a" font-family="sans-serif" font-weight="600" pointer-events="none">Rabia</text>

            <!-- Zummar - north -->
            <ellipse id="dist-Zummar" cx="80" cy="105" rx="32" ry="24" fill="#c8dbc8" stroke="#9ab89a" stroke-width="1.5" class="dist-shape" data-district="Zummar"/>
            <text x="80" y="103" text-anchor="middle" font-size="9" fill="#1a3a1a" font-family="sans-serif" font-weight="600" pointer-events="none">Zummar</text>

            <!-- Makhmur - southeast -->
            <ellipse id="dist-Makhmur" cx="360" cy="280" rx="44" ry="32" fill="#c8dbc8" stroke="#9ab89a" stroke-width="1.5" class="dist-shape" data-district="Makhmur"/>
            <text x="360" y="277" text-anchor="middle" font-size="9" fill="#1a3a1a" font-family="sans-serif" font-weight="600" pointer-events="none">Makhmur</text>

            <!-- Qa Qaa - south -->
            <ellipse id="dist-QaQaa" cx="255" cy="300" rx="46" ry="32" fill="#c8dbc8" stroke="#9ab89a" stroke-width="1.5" class="dist-shape" data-district="Qa Qaa"/>
            <text x="255" y="297" text-anchor="middle" font-size="9" fill="#1a3a1a" font-family="sans-serif" font-weight="600" pointer-events="none">Qa Qaa</text>

            <!-- Baaj - far southwest -->
            <ellipse id="dist-Baaj" cx="90" cy="320" rx="36" ry="26" fill="#c8dbc8" stroke="#9ab89a" stroke-width="1.5" class="dist-shape" data-district="Baaj"/>
            <text x="90" y="318" text-anchor="middle" font-size="9" fill="#1a3a1a" font-family="sans-serif" font-weight="600" pointer-events="none">Baaj</text>

            <!-- Akre - far northeast -->
            <ellipse id="dist-Akre" cx="430" cy="120" rx="36" ry="26" fill="#c8dbc8" stroke="#9ab89a" stroke-width="1.5" class="dist-shape" data-district="Akre"/>
            <text x="430" y="118" text-anchor="middle" font-size="9" fill="#1a3a1a" font-family="sans-serif" font-weight="600" pointer-events="none">Akre</text>

            <!-- Case count bubbles (rendered by JS) -->
            <g id="map-bubbles"></g>
          </svg>
          <div class="map-tooltip" id="map-tooltip"></div>
        </div>
        <div class="district-sidebar" id="district-sidebar"></div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="table-card">
      <div class="table-toolbar">
        <div class="search-wrap">
          <svg class="search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" placeholder="Search name or code…" oninput="renderTable()" id="search-inp">
        </div>
        <div class="toolbar-right">
          <select class="filter-sel" id="phase-filter" onchange="renderTable()">
            <option value="">All Phases</option>
            <option value="Intensive">Intensive</option>
            <option value="Continuation">Continuation</option>
            <option value="Completed">Completed</option>
          </select>
          <select class="filter-sel" id="alert-filter" onchange="renderTable()">
            <option value="">All</option>
            <option value="alert">Alerts Only</option>
          </select>
          <button class="btn-accent" onclick="openAddModal()">+ New Patient</button>
        </div>
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead><tr>
            <th>Code</th><th>Name</th><th>Age/Sex</th>
            <th>Phase</th><th>Start</th><th>Drug</th>
            <th>Refill In</th><th>Supply</th>
          </tr></thead>
          <tbody id="patients-tbody"></tbody>
        </table>
        <div class="empty-state" id="empty-state" style="display:none">No patients found. Register your first patient above.</div>
      </div>
    </div>
  </div>
</div>

<!-- PATIENT -->
<div id="patient-view">
  <div class="patient-topbar">
    <div class="pt-tb-left"><span id="pt-greeting">—</span><small id="pt-code-display">—</small></div>
    <button class="pt-logout" onclick="logout()">Logout</button>
  </div>
  <div class="pt-content" id="pt-content"></div>
</div>

</div><!-- #app -->

<!-- PANEL OVERLAY -->
<div class="panel-overlay" id="panel-overlay" onclick="closePanel()"></div>
<div class="detail-panel" id="detail-panel">
  <div class="panel-header">
    <div class="panel-htop">
      <div><div class="panel-name" id="panel-name"></div><div class="panel-meta" id="panel-meta"></div></div>
      <button class="panel-close" onclick="closePanel()">✕</button>
    </div>
  </div>
  <div class="timeline-wrap" id="panel-timeline"></div>
  <div class="panel-body" id="panel-body"></div>
  <div class="panel-footer" id="panel-footer"></div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <div class="modal-header"><h2 id="modal-title">Register New Patient</h2><button class="modal-close" onclick="closeModal()">✕</button></div>
    <div class="modal-body">
      <div class="form-section">
        <div class="form-section-title">Patient Information</div>
        <div class="form-grid">
          <div class="form-field full"><label>Full Name</label><input type="text" id="f-name" placeholder="Patient full name"></div>
          <div class="form-field"><label>Patient Code</label><input type="text" id="f-code" placeholder="NNW-001" style="font-family:var(--mono)"><div class="hint">Must be unique</div></div>
          <div class="form-field"><label>Age</label><input type="number" id="f-age" placeholder="35"></div>
          <div class="form-field"><label>Gender</label><select id="f-gender"><option value="">Select</option><option>Male</option><option>Female</option></select></div>
          <div class="form-field"><label>Phone</label><input type="text" id="f-phone" placeholder="+964 7XX XXX XXXX"></div>
          <div class="form-field"><label>Sector / District</label>
            <select id="f-sector">
              <option value="">Select district</option>
              <option>Mosul</option><option>Tal Afar</option><option>Sinjar</option>
              <option>Baaj</option><option>Rabia</option><option>Tilkaif</option>
              <option>Hamdaniya</option><option>Shekhan</option><option>Akre</option>
              <option>Makhmur</option><option>Qa Qaa</option><option>Zummar</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">TB Classification</div>
        <div class="form-grid">
          <div class="form-field"><label>TB Site</label><select id="f-site"><option value="">Select</option><option value="Pulmonary">Pulmonary (رئوي)</option><option value="Extrapulmonary">Extrapulmonary (خارج الرئة)</option></select></div>
          <div class="form-field"><label>Patient Category</label><select id="f-category"><option value="New">New Case</option><option value="Retreatment">Retreatment</option></select></div>
          <div class="form-field"><label>Smear Result</label><select id="f-smear"><option value="">Select</option><option value="Positive">Positive (+)</option><option value="Negative">Negative (-)</option><option value="Not done">Not done</option></select></div>
          <div class="form-field"><label>Health Center</label><input type="text" id="f-center" placeholder="Center name"></div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">Treatment Plan · 6 Months Total</div>
        <div class="form-grid">
          <div class="form-field"><label>Treatment Start Date</label><input type="date" id="f-start"></div>
          <div class="form-field"><label>Intensive Drug (Months 1–2)</label><select id="f-drug1"><option value="RHZE">RHZE (Standard)</option><option value="Other">Other</option></select></div>
          <div class="form-field"><label>Continuation Drug (Months 3–6)</label><select id="f-drug2"><option value="RH">RH (Standard)</option><option value="RHE">RHE</option><option value="Other">Other</option></select></div>
          <div class="form-field"><label>Daily Dose (tablets/day)</label><input type="number" id="f-daily" placeholder="4"></div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">Medication Stock</div>
        <div class="form-grid">
          <div class="form-field"><label>Total Tablets Dispensed</label><input type="number" id="f-total" placeholder="56"></div>
          <div class="form-field"><label>Tablets Currently Remaining</label><input type="number" id="f-remaining" placeholder="56"></div>
          <div class="form-field full"><label>Clinical Notes</label><input type="text" id="f-notes" placeholder="Optional notes..."></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeModal()">Cancel</button>
        <button class="btn-accent" onclick="savePatient()">Save Patient</button>
      </div>
    </div>
  </div>
</div>

<script>
// ── CONFIG ──────────────────────────────
const ADMIN_USER = 'saif';
const ADMIN_PASS = 'tb2024!secure';
const INTENSIVE_DAYS = 60;
const TOTAL_DAYS = 180;

// District → SVG element ID mapping
const DIST_IDS = {
  'mosul':'dist-Mosul','tal afar':'dist-TalAfar','sinjar':'dist-Sinjar',
  'baaj':'dist-Baaj','rabia':'dist-Rabia','tilkaif':'dist-Tilkaif',
  'hamdaniya':'dist-Hamdaniya','shekhan':'dist-Shekhan','akre':'dist-Akre',
  'makhmur':'dist-Makhmur','qa qaa':'dist-QaQaa','zummar':'dist-Zummar'
};

// Bubble center positions (cx,cy) matching SVG ellipses
const DIST_CENTERS = {
  'mosul':[215,155],'tal afar':[110,160],'sinjar':[105,250],
  'baaj':[90,320],'rabia':[150,60],'tilkaif':[230,90],
  'hamdaniya':[340,170],'shekhan':[340,90],'akre':[430,120],
  'makhmur':[360,280],'qa qaa':[255,300],'zummar':[80,105]
};

let patients = [];
try { patients = JSON.parse(localStorage.getItem('tb_patients_v2') || '[]'); } catch(e){}
let editingId = null;

function save() {
  try { localStorage.setItem('tb_patients_v2', JSON.stringify(patients)); } catch(e){}
}

// ── HELPERS ─────────────────────────────
function daysSince(ds) {
  if (!ds) return 0;
  return Math.floor((Date.now() - new Date(ds).getTime()) / 86400000);
}
function autoPhase(pt) {
  if (!pt.startDate) return 'Intensive';
  const d = daysSince(pt.startDate);
  if (d >= TOTAL_DAYS) return 'Completed';
  if (d >= INTENSIVE_DAYS) return 'Continuation';
  return 'Intensive';
}
function currentDrug(pt) {
  const p = autoPhase(pt);
  return p==='Intensive'?(pt.drug1||'RHZE'):p==='Continuation'?(pt.drug2||'RH'):'—';
}
function daysLeft(pt) {
  if (!pt.startDate) return null;
  return Math.max(0, TOTAL_DAYS - daysSince(pt.startDate));
}
function medStatus(pt) {
  const r=pt.remaining||0, t=pt.total||0;
  if (r<=0||t<=0) return 'empty';
  const p=r/t;
  if (p<=0.1) return 'critical';
  if (p<=0.25) return 'low';
  return 'ok';
}
function refillDays(pt) {
  if (!pt.daily||!pt.remaining) return null;
  return Math.floor(pt.remaining/pt.daily);
}
function fmtDate(s) {
  if (!s) return '—';
  try { return new Date(s).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}); }
  catch(e){ return s; }
}
function addDays(ds, n) {
  if (!ds) return null;
  const d = new Date(ds); d.setDate(d.getDate()+n);
  return d.toISOString().split('T')[0];
}
function normDist(s) {
  return (s||'').trim().toLowerCase();
}

// ── LOGIN ────────────────────────────────
function setTab(t) {
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',(i===0&&t==='admin')||(i===1&&t==='patient')));
  document.getElementById('admin-login-form').style.display=t==='admin'?'block':'none';
  document.getElementById('patient-login-form').style.display=t==='patient'?'block':'none';
  document.getElementById('login-error').style.display='none';
}
function showErr(msg) {
  const el=document.getElementById('login-error');
  el.textContent=msg||'Incorrect credentials.';
  el.style.display='block';
  setTimeout(()=>el.style.display='none',3500);
}
function adminLogin() {
  const u=document.getElementById('admin-user').value.trim().toLowerCase();
  const p=document.getElementById('admin-pass').value;
  if(u===ADMIN_USER&&p===ADMIN_PASS) showApp('admin');
  else showErr();
}
function patientLogin() {
  const code=document.getElementById('pt-code-inp').value.trim().toUpperCase();
  const pt=patients.find(p=>p.code.toUpperCase()===code);
  if(pt) showApp('patient',pt);
  else showErr('Patient code not found.');
}
function showApp(role,pt) {
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('admin-view').style.display=role==='admin'?'block':'none';
  document.getElementById('patient-view').style.display=role==='patient'?'block':'none';
  if(role==='admin'){ renderStats();renderAlerts();renderMap();renderTable(); }
  else renderPatientView(pt);
}
function logout() {
  document.getElementById('app').style.display='none';
  document.getElementById('login-screen').style.display='flex';
  ['admin-user','admin-pass','pt-code-inp'].forEach(id=>document.getElementById(id).value='');
  closePanel();
}
document.addEventListener('keydown',e=>{
  if(e.key!=='Enter') return;
  if(document.getElementById('admin-login-form').style.display!=='none') adminLogin();
  else patientLogin();
});

// ── STATS ────────────────────────────────
function renderStats() {
  const tot=patients.length;
  const intv=patients.filter(p=>autoPhase(p)==='Intensive').length;
  const cont=patients.filter(p=>autoPhase(p)==='Continuation').length;
  const alrt=patients.filter(p=>['critical','low','empty'].includes(medStatus(p))&&autoPhase(p)!=='Completed').length;
  const comp=patients.filter(p=>autoPhase(p)==='Completed').length;
  const soon=patients.filter(p=>{const r=refillDays(p);return r!==null&&r<=7&&autoPhase(p)!=='Completed';}).length;
  document.getElementById('stats-grid').innerHTML=`
    <div class="stat-card"><div class="stat-label">Total</div><div class="stat-val">${tot}</div></div>
    <div class="stat-card"><div class="stat-label">Intensive</div><div class="stat-val amber">${intv}</div></div>
    <div class="stat-card"><div class="stat-label">Continuation</div><div class="stat-val blue">${cont}</div></div>
    <div class="stat-card"><div class="stat-label">Alerts</div><div class="stat-val ${alrt>0?'red':'green'}">${alrt}</div></div>
    <div class="stat-card"><div class="stat-label">Refill ≤7d</div><div class="stat-val ${soon>0?'amber':'green'}">${soon}</div></div>
    <div class="stat-card"><div class="stat-label">Completed</div><div class="stat-val green">${comp}</div></div>
  `;
}

// ── ALERTS ───────────────────────────────
function renderAlerts() {
  const banner=document.getElementById('alerts-banner');
  const items=[];
  patients.forEach(pt=>{
    if(autoPhase(pt)==='Completed') return;
    const s=medStatus(pt),r=refillDays(pt);
    if(s==='empty') items.push({pt,type:'danger',msg:`${pt.name} (${pt.code}) — Medication EMPTY. Resupply immediately.`});
    else if(s==='critical') items.push({pt,type:'danger',msg:`${pt.name} (${pt.code}) — Critical: ${pt.remaining} tablets left (${r} days).`});
    else if(s==='low') items.push({pt,type:'warn',msg:`${pt.name} (${pt.code}) — Low supply: ~${r} days remaining.`});
    else if(r!==null&&r<=7) items.push({pt,type:'warn',msg:`${pt.name} (${pt.code}) — Refill due in ${r} days.`});
  });
  if(!items.length){banner.style.display='none';return;}
  banner.style.display='block';
  banner.innerHTML=items.map(i=>`
    <div class="alert-item ${i.type==='warn'?'warn':''}" onclick="openPanel('${i.pt.id}')">
      <div class="alert-dot ${i.type==='warn'?'warn':''}"></div><span>${i.msg}</span>
    </div>`).join('');
}

// ── MAP ──────────────────────────────────
function renderMap() {
  // Count active patients per district
  const counts={};
  patients.forEach(pt=>{
    if(!pt.sector||autoPhase(pt)==='Completed') return;
    const k=normDist(pt.sector);
    counts[k]=(counts[k]||0)+1;
  });

  // Reset all district shapes
  document.querySelectorAll('.dist-shape').forEach(el=>{
    el.style.fill='#c8dbc8';
    el.style.stroke='#9ab89a';
  });

  // Color districts by count
  const bubbles=document.getElementById('map-bubbles');
  bubbles.innerHTML='';

  Object.entries(counts).forEach(([name,count])=>{
    const color=count>=5?'#dc2626':count>=2?'#d97706':'#16a34a';
    const fillLight=count>=5?'#fee2e2':count>=2?'#fef3c7':'#dcfce7';

    // Color the shape
    const elId=DIST_IDS[name];
    if(elId){
      const el=document.getElementById(elId);
      if(el){el.style.fill=fillLight;el.style.stroke=color;}
    }

    // Add bubble
    const center=DIST_CENTERS[name];
    if(center){
      const [cx,cy]=center;
      const r=Math.max(14,Math.min(26,10+count*4));
      const bubble=document.createElementNS('http://www.w3.org/2000/svg','circle');
      bubble.setAttribute('cx',cx); bubble.setAttribute('cy',cy-28);
      bubble.setAttribute('r',r); bubble.setAttribute('fill',color);
      bubble.setAttribute('stroke','white'); bubble.setAttribute('stroke-width','2');
      bubble.style.filter='drop-shadow(0 2px 4px rgba(0,0,0,.25))';
      bubble.style.cursor='pointer';
      bubbles.appendChild(bubble);

      const label=document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x',cx); label.setAttribute('y',cy-24);
      label.setAttribute('text-anchor','middle'); label.setAttribute('dominant-baseline','middle');
      label.setAttribute('font-size',r>18?13:11); label.setAttribute('font-weight','700');
      label.setAttribute('fill','white'); label.setAttribute('font-family','sans-serif');
      label.setAttribute('pointer-events','none');
      label.textContent=count;
      bubbles.appendChild(label);
    }
  });

  // District shapes clickable
  document.querySelectorAll('.dist-shape').forEach(el=>{
    el.onclick=()=>{
      const name=el.getAttribute('data-district');
      document.getElementById('search-inp').value=name;
      renderTable();
      el.closest('.map-card').nextElementSibling?.scrollIntoView({behavior:'smooth',block:'start'});
    };
  });

  // Tooltip on hover (desktop)
  const tooltip=document.getElementById('map-tooltip');
  const wrap=document.getElementById('svg-map-wrap');
  document.querySelectorAll('.dist-shape').forEach(el=>{
    const name=el.getAttribute('data-district');
    const k=normDist(name);
    const count=counts[k]||0;
    el.addEventListener('mouseenter',e=>{
      tooltip.innerHTML=`<strong>${name}</strong><br>Active cases: ${count}${count>0?'<br><span style="opacity:.7;font-size:11px">Tap to filter table</span>':''}`;
      tooltip.style.display='block';
    });
    el.addEventListener('mousemove',e=>{
      const rect=wrap.getBoundingClientRect();
      tooltip.style.left=(e.clientX-rect.left+10)+'px';
      tooltip.style.top=(e.clientY-rect.top-10)+'px';
    });
    el.addEventListener('mouseleave',()=>tooltip.style.display='none');
  });

  // Sidebar list
  const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  const sidebar=document.getElementById('district-sidebar');
  if(!sorted.length){
    sidebar.innerHTML='<div class="map-empty">No active patients with districts assigned yet.</div>';
    return;
  }
  const max=sorted[0][1];
  sidebar.innerHTML=sorted.map(([name,count])=>{
    const color=count>=5?'#dc2626':count>=2?'#d97706':'#16a34a';
    const displayName=Object.keys(DIST_IDS).find(k=>k===name);
    const label=name.charAt(0).toUpperCase()+name.slice(1);
    return `<div class="dist-row" onclick="filterByDistrict('${label}')">
      <span class="dist-name">${label}</span>
      <div class="dist-bar-wrap"><div class="dist-bar" style="width:${Math.round(count/max*100)}%;background:${color}"></div></div>
      <span class="dist-count" style="color:${color}">${count}</span>
    </div>`;
  }).join('');
}

function filterByDistrict(name){
  document.getElementById('search-inp').value=name;
  renderTable();
}

// ── TABLE ────────────────────────────────
function renderTable(){
  const q=(document.getElementById('search-inp').value||'').toLowerCase();
  const pf=document.getElementById('phase-filter').value;
  const af=document.getElementById('alert-filter').value;
  let list=patients.filter(pt=>{
    const ph=autoPhase(pt),s=medStatus(pt);
    if(q&&!pt.name.toLowerCase().includes(q)&&!pt.code.toLowerCase().includes(q)&&!(pt.sector||'').toLowerCase().includes(q)) return false;
    if(pf&&ph!==pf) return false;
    if(af==='alert'&&!['critical','low','empty'].includes(s)) return false;
    return true;
  });
  const tbody=document.getElementById('patients-tbody');
  document.getElementById('empty-state').style.display=list.length?'none':'block';
  if(!list.length){tbody.innerHTML='';return;}
  tbody.innerHTML=list.map(pt=>{
    const ph=autoPhase(pt),s=medStatus(pt),r=refillDays(pt);
    const phPill=ph==='Intensive'?`<span class="pill phase1">Intensive</span>`
      :ph==='Continuation'?`<span class="pill phase2">Continuation</span>`
      :`<span class="pill pdone">✓ Done</span>`;
    const supPill=s==='ok'?`<span class="pill med-ok">OK</span>`
      :s==='low'?`<span class="pill med-low">Low</span>`
      :(s==='critical'||s==='empty')?`<span class="pill med-crit">${s==='empty'?'Empty':'Critical'}</span>`
      :`<span class="pill neutral">—</span>`;
    const refillTxt=r===null?'—':r<=7?`<span style="color:var(--danger);font-weight:700">${r}d ⚠</span>`
      :r<=14?`<span style="color:var(--warn);font-weight:600">${r}d</span>`:`${r}d`;
    return `<tr onclick="openPanel('${pt.id}')">
      <td><span class="code-tag">${pt.code}</span></td>
      <td><strong>${pt.name}</strong></td>
      <td>${pt.age||'—'}/${pt.gender?pt.gender[0]:'—'}</td>
      <td>${phPill}</td>
      <td>${fmtDate(pt.startDate)}</td>
      <td><span style="font-family:var(--mono);font-size:12px">${currentDrug(pt)}</span></td>
      <td>${refillTxt}</td>
      <td>${supPill}</td>
    </tr>`;
  }).join('');
}

// ── PANEL ────────────────────────────────
function openPanel(id){
  const pt=patients.find(p=>p.id===id);
  if(!pt) return;
  const ph=autoPhase(pt);
  const d=pt.startDate?daysSince(pt.startDate):0;
  const iPct=Math.min(100,d>=INTENSIVE_DAYS?100:Math.round(d/INTENSIVE_DAYS*100));
  const cPct=d>=INTENSIVE_DAYS?Math.min(100,Math.round((d-INTENSIVE_DAYS)/(TOTAL_DAYS-INTENSIVE_DAYS)*100)):0;
  const dl=daysLeft(pt);
  const contDate=addDays(pt.startDate,INTENSIVE_DAYS);
  const endDate=addDays(pt.startDate,TOTAL_DAYS);

  document.getElementById('panel-name').textContent=pt.name;
  document.getElementById('panel-meta').innerHTML=`
    <span class="pill ${ph==='Intensive'?'phase1':ph==='Continuation'?'phase2':'pdone'}">${ph}</span>
    <span class="code-tag">${pt.code}</span>
    ${pt.category?`<span class="pill neutral">${pt.category}</span>`:''}
    ${pt.site?`<span class="pill neutral">${pt.site}</span>`:''}
  `;

  const p1w=iPct*(INTENSIVE_DAYS/TOTAL_DAYS);
  const p2w=cPct*((TOTAL_DAYS-INTENSIVE_DAYS)/TOTAL_DAYS);
  document.getElementById('panel-timeline').innerHTML=`
    <div class="tl-label"><span style="color:var(--phase1)">Intensive · RHZE</span><span style="color:var(--phase2)">Continuation · RH</span></div>
    <div class="tl-track"><div class="tl-p1" style="width:${p1w}%"></div><div class="tl-p2" style="width:${p2w}%"></div></div>
    <div class="tl-months"><span>Start</span><span>Month 2</span><span>Month 4</span><span>Month 6</span></div>
    <div class="tl-info">
      <div class="tl-block" style="background:var(--phase1-light)"><div class="tv" style="color:var(--phase1)">${iPct}%</div><div class="tl">Intensive</div></div>
      <div class="tl-block" style="background:var(--phase2-light)"><div class="tv" style="color:var(--phase2)">${cPct}%</div><div class="tl">Continuation</div></div>
      <div class="tl-block" style="background:var(--surface2);border:1px solid var(--border)"><div class="tv">${dl!==null?dl+'d':'—'}</div><div class="tl">Days left</div></div>
    </div>
  `;

  const rem=pt.remaining||0,tot=pt.total||0;
  const pct=tot>0?Math.round(rem/tot*100):0;
  const s=medStatus(pt),r=refillDays(pt);
  const barClass=s==='ok'?'ok':(s==='critical'||s==='empty')?'danger':'warn';
  let alertHtml=s==='empty'
    ?`<div class="med-alert danger">⚠ Medication depleted — immediate resupply required.</div>`
    :s==='critical'
    ?`<div class="med-alert danger">⚠ Critical — only ${r} days remaining.</div>`
    :s==='low'
    ?`<div class="med-alert warn">⚠ Low supply — ~${r} days remaining. Schedule resupply.</div>`
    :r!==null&&r<=7
    ?`<div class="med-alert warn">⚠ Refill due in ${r} days (${fmtDate(addDays(new Date().toISOString().split('T')[0],r))}).</div>`
    :`<div class="med-alert ok">✓ Supply adequate — ${r} days (${r!==null?Math.floor(r/7):'?'} weeks).</div>`;

  document.getElementById('panel-body').innerHTML=`
    <div class="info-section">
      <div class="info-section-title">Patient Information</div>
      <div class="info-grid">
        <div class="info-cell"><div class="info-key">Age / Gender</div><div class="info-val">${pt.age||'—'} / ${pt.gender||'—'}</div></div>
        <div class="info-cell"><div class="info-key">Phone</div><div class="info-val" style="font-family:var(--mono);font-size:12px">${pt.phone||'—'}</div></div>
        <div class="info-cell"><div class="info-key">Sector</div><div class="info-val">${pt.sector||'—'}</div></div>
        <div class="info-cell"><div class="info-key">Health Center</div><div class="info-val">${pt.center||'—'}</div></div>
        <div class="info-cell"><div class="info-key">TB Site</div><div class="info-val">${pt.site||'—'}</div></div>
        <div class="info-cell"><div class="info-key">Smear</div><div class="info-val">${pt.smear||'—'}</div></div>
        <div class="info-cell"><div class="info-key">Category</div><div class="info-val">${pt.category||'—'}</div></div>
        <div class="info-cell"><div class="info-key">Current Drug</div><div class="info-val" style="font-family:var(--mono);font-weight:700">${currentDrug(pt)}</div></div>
        <div class="info-cell full"><div class="info-key">Treatment Period</div><div class="info-val">${fmtDate(pt.startDate)} → ${fmtDate(endDate)} &nbsp;·&nbsp; Continuation from ${fmtDate(contDate)}</div></div>
        ${pt.notes?`<div class="info-cell full"><div class="info-key">Notes</div><div class="info-val">${pt.notes}</div></div>`:''}
      </div>
    </div>
    <div class="info-section">
      <div class="info-section-title">Medication Tracker</div>
      <div class="med-tracker">
        <div class="med-top">
          <div><div class="med-count">${rem} <span style="font-size:15px;color:var(--text2)">/ ${tot}</span></div><div class="med-sub">tablets remaining</div></div>
          <div style="text-align:right"><div style="font-size:20px;font-weight:700;font-family:var(--mono);color:${s==='ok'?'var(--ok)':s==='low'?'var(--warn)':'var(--danger)'}">${pct}%</div><div class="med-sub">${pt.daily||'—'} tabs/day</div></div>
        </div>
        <div class="med-bar-track"><div class="med-bar-fill ${barClass}" style="width:${pct}%"></div></div>
        <div class="med-stats">
          <span>Daily: ${pt.daily||'—'}</span>
          <span>Weekly: ${pt.daily?pt.daily*7:'—'}</span>
          ${r!==null?`<span>Runs out: ${fmtDate(addDays(new Date().toISOString().split('T')[0],r))}</span>`:''}
        </div>
        ${alertHtml}
        <div class="update-row">
          <input type="number" id="upd-inp" value="${rem}" placeholder="New count" min="0">
          <button class="btn-sm green" onclick="updateMeds('${pt.id}')">Update</button>
        </div>
      </div>
    </div>
  `;

  document.getElementById('panel-footer').innerHTML=`
    <button class="btn-sm gray" onclick="openEditModal('${pt.id}')">✏ Edit</button>
    <button class="btn-sm red" onclick="deletePatient('${pt.id}')">Delete</button>
  `;

  document.getElementById('panel-overlay').style.display='block';
  document.getElementById('detail-panel').classList.add('open');
}

function closePanel(){
  document.getElementById('detail-panel').classList.remove('open');
  document.getElementById('panel-overlay').style.display='none';
}
function updateMeds(id){
  const val=parseInt(document.getElementById('upd-inp').value);
  if(isNaN(val)||val<0) return;
  const pt=patients.find(p=>p.id===id);
  if(!pt) return;
  pt.remaining=val;
  save();renderStats();renderAlerts();renderMap();renderTable();openPanel(id);
}
function deletePatient(id){
  if(!confirm('Permanently delete this patient record?')) return;
  patients=patients.filter(p=>p.id!==id);
  save();renderStats();renderAlerts();renderMap();renderTable();closePanel();
}

// ── MODAL ────────────────────────────────
function clearForm(){
  ['name','phone','center','notes'].forEach(f=>document.getElementById('f-'+f).value='');
  document.getElementById('f-age').value='';
  document.getElementById('f-gender').value='';
  document.getElementById('f-sector').value='';
  document.getElementById('f-site').value='';
  document.getElementById('f-category').value='New';
  document.getElementById('f-smear').value='';
  document.getElementById('f-drug1').value='RHZE';
  document.getElementById('f-drug2').value='RH';
  document.getElementById('f-daily').value='';
  document.getElementById('f-total').value='';
  document.getElementById('f-remaining').value='';
  document.getElementById('f-start').value=new Date().toISOString().split('T')[0];
  document.getElementById('f-code').value='';
}
function openAddModal(){
  editingId=null;
  document.getElementById('modal-title').textContent='Register New Patient';
  clearForm();
  document.getElementById('modal-overlay').style.display='flex';
}
function openEditModal(id){
  const pt=patients.find(p=>p.id===id);
  if(!pt) return;
  editingId=id;
  document.getElementById('modal-title').textContent='Edit Patient';
  document.getElementById('f-name').value=pt.name||'';
  document.getElementById('f-code').value=pt.code||'';
  document.getElementById('f-age').value=pt.age||'';
  document.getElementById('f-gender').value=pt.gender||'';
  document.getElementById('f-phone').value=pt.phone||'';
  document.getElementById('f-sector').value=pt.sector||'';
  document.getElementById('f-site').value=pt.site||'';
  document.getElementById('f-category').value=pt.category||'New';
  document.getElementById('f-smear').value=pt.smear||'';
  document.getElementById('f-center').value=pt.center||'';
  document.getElementById('f-start').value=pt.startDate||'';
  document.getElementById('f-drug1').value=pt.drug1||'RHZE';
  document.getElementById('f-drug2').value=pt.drug2||'RH';
  document.getElementById('f-daily').value=pt.daily||'';
  document.getElementById('f-total').value=pt.total||'';
  document.getElementById('f-remaining').value=pt.remaining||'';
  document.getElementById('f-notes').value=pt.notes||'';
  document.getElementById('modal-overlay').style.display='flex';
}
function closeModal(){ document.getElementById('modal-overlay').style.display='none'; }
function savePatient(){
  const name=document.getElementById('f-name').value.trim();
  const code=document.getElementById('f-code').value.trim().toUpperCase();
  if(!name){alert('Patient name is required.');return;}
  if(!code){alert('Patient code is required.');return;}
  const dup=patients.find(p=>p.code.toUpperCase()===code&&p.id!==editingId);
  if(dup){alert('This patient code is already in use.');return;}
  const data={
    name,code,
    age:document.getElementById('f-age').value,
    gender:document.getElementById('f-gender').value,
    phone:document.getElementById('f-phone').value.trim(),
    sector:document.getElementById('f-sector').value,
    site:document.getElementById('f-site').value,
    category:document.getElementById('f-category').value,
    smear:document.getElementById('f-smear').value,
    center:document.getElementById('f-center').value.trim(),
    startDate:document.getElementById('f-start').value,
    drug1:document.getElementById('f-drug1').value,
    drug2:document.getElementById('f-drug2').value,
    daily:parseInt(document.getElementById('f-daily').value)||0,
    total:parseInt(document.getElementById('f-total').value)||0,
    remaining:parseInt(document.getElementById('f-remaining').value)||0,
    notes:document.getElementById('f-notes').value.trim(),
  };
  if(editingId){
    const idx=patients.findIndex(p=>p.id===editingId);
    patients[idx]={...patients[idx],...data};
  } else {
    data.id='pt_'+Date.now();
    patients.push(data);
  }
  save();closeModal();renderStats();renderAlerts();renderMap();renderTable();
  if(editingId) openPanel(editingId);
}

// ── PATIENT VIEW ─────────────────────────
function renderPatientView(pt){
  document.getElementById('pt-greeting').textContent=pt.name;
  document.getElementById('pt-code-display').textContent=pt.code;
  const ph=autoPhase(pt),dl=daysLeft(pt);
  const rem=pt.remaining||0,tot=pt.total||0;
  const pct=tot>0?Math.round(rem/tot*100):0;
  const s=medStatus(pt),r=refillDays(pt);
  const d=pt.startDate?daysSince(pt.startDate):0;
  const iPct=Math.min(100,d>=INTENSIVE_DAYS?100:Math.round(d/INTENSIVE_DAYS*100));
  const cPct=d>=INTENSIVE_DAYS?Math.min(100,Math.round((d-INTENSIVE_DAYS)/(TOTAL_DAYS-INTENSIVE_DAYS)*100)):0;
  const ringColor=s==='ok'?'#16a34a':(s==='critical'||s==='empty')?'#dc2626':'#d97706';
  const C=2*Math.PI*34;
  const offset=C-(C*pct/100);
  const contDate=addDays(pt.startDate,INTENSIVE_DAYS);
  const endDate=addDays(pt.startDate,TOTAL_DAYS);
  let alertMsg=s==='empty'
    ?`<div class="med-alert danger" style="margin-top:0">⚠ Your medication has run out. Contact your health worker immediately.</div>`
    :s==='critical'
    ?`<div class="med-alert danger" style="margin-top:0">⚠ Very low — only ${r} days left. Contact your health worker now.</div>`
    :s==='low'
    ?`<div class="med-alert warn" style="margin-top:0">⚠ Getting low — about ${r} days remaining. Schedule a pickup.</div>`
    :`<div class="med-alert ok" style="margin-top:0">✓ You have enough medication for ${r!==null?Math.floor(r/7):'?'} more weeks.</div>`;

  document.getElementById('pt-content').innerHTML=`
    <div class="pt-card">
      <h2>My Treatment</h2>
      <div class="pt-row"><span class="pt-row-key">Current Phase</span>
        <span class="pill ${ph==='Intensive'?'phase1':ph==='Continuation'?'phase2':'pdone'}">${ph}</span></div>
      <div class="pt-row"><span class="pt-row-key">Current Medication</span><span class="pt-row-val" style="font-family:var(--mono)">${currentDrug(pt)}</span></div>
      <div class="pt-row"><span class="pt-row-key">Treatment Started</span><span class="pt-row-val">${fmtDate(pt.startDate)}</span></div>
      <div class="pt-row"><span class="pt-row-key">Continuation Starts</span><span class="pt-row-val">${fmtDate(contDate)}</span></div>
      <div class="pt-row"><span class="pt-row-key">Treatment Ends</span><span class="pt-row-val">${fmtDate(endDate)}</span></div>
      <div class="pt-row"><span class="pt-row-key">Days Remaining</span><span class="pt-row-val" style="color:var(--accent)">${dl!==null?dl+' days':'—'}</span></div>
    </div>
    <div class="pt-card">
      <h2>Medication Supply</h2>
      <div class="ring-wrap">
        <svg class="ring-svg" viewBox="0 0 88 88">
          <circle class="ring-bg" cx="44" cy="44" r="34"/>
          <circle class="ring-fill" cx="44" cy="44" r="34" stroke="${ringColor}" stroke-dasharray="${C}" stroke-dashoffset="${offset}"/>
          <text class="ring-text" x="44" y="44">${pct}%</text>
        </svg>
        <div class="ring-info">
          <h3>${rem} tablets</h3>
          <p>of ${tot} total</p>
          ${r!==null?`<div class="wk">${Math.floor(r/7)} weeks · ${r} days</div>`:''}
        </div>
      </div>
      <div style="margin-top:12px">${alertMsg}</div>
    </div>
    <div class="pt-card">
      <h2>6-Month Treatment Progress</h2>
      <div class="pt-tl-track">
        <div class="pt-tl-p1" style="width:${iPct*(INTENSIVE_DAYS/TOTAL_DAYS)}%"></div>
        <div class="pt-tl-p2" style="width:${cPct*((TOTAL_DAYS-INTENSIVE_DAYS)/TOTAL_DAYS)}%"></div>
      </div>
      <div class="pt-tl-labels"><span>Start</span><span>Month 2</span><span>Month 4</span><span>Month 6</span></div>
      <div class="pt-phase-blocks">
        <div class="pt-phase-block" style="background:var(--phase1-light)">
          <div class="pb-label" style="color:#92400e">Intensive</div>
          <div class="pb-med" style="color:var(--phase1)">${pt.drug1||'RHZE'}</div>
          <div class="pb-sub" style="color:#92400e">${iPct}% complete</div>
        </div>
        <div class="pt-phase-block" style="background:var(--phase2-light)">
          <div class="pb-label" style="color:#1e40af">Continuation</div>
          <div class="pb-med" style="color:var(--phase2)">${pt.drug2||'RH'}</div>
          <div class="pb-sub" style="color:#1e40af">${cPct}% complete</div>
        </div>
      </div>
    </div>
    ${pt.notes?`<div class="pt-card"><h2>Notes from Health Worker</h2><p style="font-size:13px;color:var(--text2);line-height:1.7">${pt.notes}</p></div>`:''}
  `;
}

document.getElementById('modal-overlay').addEventListener('click',function(e){if(e.target===this)closeModal();});
</script>
</body>
</html>
