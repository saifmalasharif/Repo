{
  "returncode" : 0,
  "stdout" : "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n<meta charset=\"UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no\">\n<title>TB Care · Ninawa<\/title>\n<style>\n\/* ── SYSTEM FONTS — no external load ── *\/\n:root {\n  --bg: #f2f4f7;\n  --surface: #fff;\n  --surface2: #f8f9fb;\n  --border: #e3e7ed;\n  --accent: #1a5c3e;\n  --accent-light: #eaf4ee;\n  --phase1: #d97706;\n  --phase1-light: #fef3c7;\n  --phase2: #2563eb;\n  --phase2-light: #dbeafe;\n  --danger: #dc2626;\n  --danger-light: #fee2e2;\n  --warn: #d97706;\n  --warn-light: #fef3c7;\n  --ok: #16a34a;\n  --ok-light: #dcfce7;\n  --text: #111827;\n  --text2: #4b5563;\n  --text3: #9ca3af;\n  --mono: ui-monospace, 'Courier New', monospace;\n  --sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n  --radius: 14px;\n  --shadow: 0 1px 3px rgba(0,0,0,.08), 0 8px 24px rgba(0,0,0,.06);\n}\n* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }\nbody { font-family: var(--sans); background: var(--bg); color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased; }\n\n\/* LOGIN *\/\n#login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(160deg,#0b2418 0%,#1a5c3e 55%,#23895c 100%); padding: 20px; }\n.login-card { background: #fff; border-radius: 22px; padding: 40px 36px; width: 100%; max-width: 390px; box-shadow: 0 32px 80px rgba(0,0,0,.28); }\n.login-mark { display: flex; align-items: center; gap: 11px; margin-bottom: 26px; }\n.login-mark-icon { width: 44px; height: 44px; background: var(--accent); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }\n.login-mark-icon svg { width: 24px; height: 24px; fill: white; }\n.lm-title { font-size: 17px; font-weight: 700; }\n.lm-sub { font-size: 11px; color: var(--text2); margin-top: 1px; letter-spacing: .04em; }\n.tab-row { display: flex; gap: 3px; background: var(--bg); border-radius: 10px; padding: 3px; margin-bottom: 24px; }\n.tab-btn { flex: 1; padding: 9px; border: none; background: transparent; border-radius: 8px; font-family: var(--sans); font-size: 13px; font-weight: 500; cursor: pointer; color: var(--text2); transition: all .18s; }\n.tab-btn.active { background: #fff; color: var(--accent); box-shadow: 0 1px 4px rgba(0,0,0,.1); font-weight: 700; }\n.field { margin-bottom: 13px; }\n.field label { display: block; font-size: 11px; font-weight: 600; color: var(--text2); margin-bottom: 5px; letter-spacing: .06em; text-transform: uppercase; }\n.field input { width: 100%; padding: 11px 13px; border: 1.5px solid var(--border); border-radius: 9px; font-family: var(--sans); font-size: 15px; color: var(--text); background: var(--surface2); outline: none; -webkit-appearance: none; }\n.field input:focus { border-color: var(--accent); background: #fff; }\n.btn-primary { width: 100%; padding: 14px; background: var(--accent); color: #fff; border: none; border-radius: 10px; font-family: var(--sans); font-size: 15px; font-weight: 700; cursor: pointer; margin-top: 6px; -webkit-appearance: none; }\n.login-error { color: var(--danger); font-size: 12px; margin-top: 10px; text-align: center; display: none; padding: 8px; background: var(--danger-light); border-radius: 8px; }\n\n\/* APP *\/\n#app { display: none; min-height: 100vh; }\n#admin-view, #patient-view { display: none; }\n\n\/* TOPBAR *\/\n.topbar { background: #fff; border-bottom: 1px solid var(--border); padding: 0 18px; height: 56px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }\n.topbar-brand { display: flex; align-items: center; gap: 9px; }\n.topbar-icon { width: 30px; height: 30px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; }\n.topbar-icon svg { width: 17px; height: 17px; fill: white; }\n.topbar-title { font-size: 15px; font-weight: 700; }\n.topbar-sub { font-size: 10px; color: var(--text2); letter-spacing: .04em; }\n.topbar-right { display: flex; align-items: center; gap: 8px; }\n.chip { font-size: 11px; font-family: var(--mono); background: var(--accent-light); color: var(--accent); padding: 4px 10px; border-radius: 20px; font-weight: 600; }\n.btn-ghost { padding: 7px 12px; border: 1.5px solid var(--border); background: #fff; border-radius: 8px; font-family: var(--sans); font-size: 12px; font-weight: 500; cursor: pointer; color: var(--text2); }\n\n\/* CONTENT *\/\n.admin-content { padding: 16px; max-width: 1100px; margin: 0 auto; }\n\n\/* STATS *\/\n.stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }\n@media(min-width:600px){ .stats-grid { grid-template-columns: repeat(6,1fr); } }\n.stat-card { background: #fff; border-radius: var(--radius); padding: 14px 16px; border: 1px solid var(--border); }\n.stat-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: .06em; color: var(--text3); margin-bottom: 6px; }\n.stat-val { font-size: 26px; font-weight: 700; font-family: var(--mono); line-height: 1; }\n.stat-val.green { color: var(--ok); }\n.stat-val.amber { color: var(--warn); }\n.stat-val.red { color: var(--danger); }\n.stat-val.blue { color: var(--phase2); }\n\n\/* ALERTS *\/\n.alerts-banner { margin-bottom: 14px; display: none; }\n.alert-item { display: flex; align-items: flex-start; gap: 9px; background: var(--danger-light); border: 1px solid #fca5a5; border-radius: 10px; padding: 10px 13px; margin-bottom: 6px; font-size: 13px; color: #7f1d1d; cursor: pointer; }\n.alert-item.warn { background: var(--warn-light); border-color: #fcd34d; color: #78350f; }\n.alert-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--danger); flex-shrink: 0; margin-top: 4px; }\n.alert-dot.warn { background: var(--warn); }\n\n\/* MAP CARD *\/\n.map-card { background: #fff; border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; box-shadow: var(--shadow); margin-bottom: 16px; }\n.map-header { padding: 13px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }\n.map-header h3 { font-size: 14px; font-weight: 700; }\n.map-header p { font-size: 11px; color: var(--text2); margin-top: 1px; }\n.map-legend { display: flex; gap: 12px; flex-wrap: wrap; }\n.legend-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--text2); }\n.legend-dot { width: 10px; height: 10px; border-radius: 50%; }\n.map-body { display: flex; flex-direction: column; }\n@media(min-width:700px){ .map-body { flex-direction: row; } }\n#svg-map-wrap { flex: 1; min-height: 300px; background: #e8f0e9; position: relative; overflow: hidden; }\n#svg-map-wrap svg { width: 100%; height: 100%; display: block; }\n.district-sidebar { width: 100%; border-top: 1px solid var(--border); overflow-y: auto; max-height: 300px; }\n@media(min-width:700px){ .district-sidebar { width: 220px; border-top: none; border-left: 1px solid var(--border); max-height: 380px; } }\n.dist-row { display: flex; align-items: center; justify-content: space-between; padding: 9px 13px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background .1s; font-size: 13px; }\n.dist-row:hover { background: var(--accent-light); }\n.dist-row:last-child { border-bottom: none; }\n.dist-name { font-weight: 500; }\n.dist-bar-wrap { flex: 1; margin: 0 8px; height: 4px; background: var(--border); border-radius: 99px; overflow: hidden; }\n.dist-bar { height: 100%; border-radius: 99px; }\n.dist-count { font-family: var(--mono); font-size: 11px; font-weight: 700; min-width: 28px; text-align: right; }\n.map-empty { padding: 32px 16px; text-align: center; color: var(--text3); font-size: 13px; }\n\n\/* TABLE *\/\n.table-card { background: #fff; border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; box-shadow: var(--shadow); }\n.table-toolbar { padding: 12px 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }\n.search-wrap { position: relative; flex: 1; min-width: 160px; max-width: 280px; }\n.search-wrap input { width: 100%; padding: 9px 12px 9px 32px; border: 1.5px solid var(--border); border-radius: 8px; font-family: var(--sans); font-size: 13px; outline: none; background: var(--surface2); -webkit-appearance: none; }\n.search-wrap input:focus { border-color: var(--accent); }\n.search-icon { position: absolute; left: 9px; top: 50%; transform: translateY(-50%); opacity: .4; }\n.toolbar-right { display: flex; gap: 7px; align-items: center; flex-wrap: wrap; }\n.filter-sel { padding: 8px 9px; border: 1.5px solid var(--border); border-radius: 8px; font-family: var(--sans); font-size: 12px; background: var(--surface2); color: var(--text2); outline: none; cursor: pointer; -webkit-appearance: none; }\n.btn-accent { padding: 9px 15px; background: var(--accent); color: #fff; border: none; border-radius: 9px; font-family: var(--sans); font-size: 13px; font-weight: 700; cursor: pointer; white-space: nowrap; }\n\ntable { width: 100%; border-collapse: collapse; }\nthead th { padding: 9px 14px; text-align: left; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; color: var(--text3); background: var(--surface2); border-bottom: 1px solid var(--border); white-space: nowrap; }\ntbody tr { border-bottom: 1px solid var(--border); cursor: pointer; transition: background .1s; }\ntbody tr:last-child { border-bottom: none; }\ntbody tr:hover { background: var(--accent-light); }\ntbody td { padding: 11px 14px; font-size: 13px; }\n.code-tag { font-family: var(--mono); font-size: 11px; background: var(--surface2); border: 1px solid var(--border); padding: 3px 7px; border-radius: 5px; }\n.pill { display: inline-flex; align-items: center; padding: 3px 9px; border-radius: 20px; font-size: 11px; font-weight: 700; white-space: nowrap; }\n.pill.phase1 { background: var(--phase1-light); color: #92400e; }\n.pill.phase2 { background: var(--phase2-light); color: #1e40af; }\n.pill.pdone { background: var(--ok-light); color: #166534; }\n.pill.med-ok { background: var(--ok-light); color: #166534; }\n.pill.med-low { background: var(--warn-light); color: #92400e; }\n.pill.med-crit { background: var(--danger-light); color: #991b1b; }\n.pill.neutral { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); }\n.empty-state { text-align: center; padding: 48px 20px; color: var(--text3); font-size: 13px; }\n\n\/* PANEL *\/\n.panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.35); z-index: 140; display: none; }\n.detail-panel { position: fixed; right: 0; top: 0; bottom: 0; width: min(460px, 100vw); background: #fff; border-left: 1px solid var(--border); z-index: 150; transform: translateX(100%); transition: transform .26s ease; display: flex; flex-direction: column; overflow: hidden; }\n.detail-panel.open { transform: translateX(0); }\n.panel-header { padding: 16px 20px; border-bottom: 1px solid var(--border); }\n.panel-htop { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 9px; }\n.panel-name { font-size: 17px; font-weight: 700; }\n.panel-meta { display: flex; gap: 5px; flex-wrap: wrap; }\n.panel-close { width: 30px; height: 30px; border: none; background: var(--bg); border-radius: 7px; cursor: pointer; font-size: 16px; color: var(--text2); flex-shrink: 0; display: flex; align-items: center; justify-content: center; }\n.timeline-wrap { padding: 13px 20px; border-bottom: 1px solid var(--border); background: var(--surface2); }\n.tl-label { display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; margin-bottom: 6px; }\n.tl-track { height: 12px; background: var(--border); border-radius: 99px; overflow: hidden; display: flex; }\n.tl-p1 { height: 100%; background: var(--phase1); }\n.tl-p2 { height: 100%; background: var(--phase2); }\n.tl-months { display: flex; justify-content: space-between; margin-top: 4px; }\n.tl-months span { font-size: 10px; color: var(--text3); }\n.tl-info { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 7px; margin-top: 9px; }\n.tl-block { border-radius: 8px; padding: 7px 9px; text-align: center; }\n.tl-block .tv { font-size: 15px; font-weight: 700; font-family: var(--mono); }\n.tl-block .tl { font-size: 10px; color: var(--text2); margin-top: 1px; text-transform: uppercase; }\n.panel-body { padding: 16px 20px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }\n.info-section { margin-bottom: 18px; }\n.info-section-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; color: var(--text3); margin-bottom: 9px; }\n.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border); border-radius: 10px; overflow: hidden; border: 1px solid var(--border); }\n.info-cell { background: #fff; padding: 9px 12px; }\n.info-cell.full { grid-column: 1\/-1; }\n.info-key { font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: .05em; margin-bottom: 2px; }\n.info-val { font-size: 13px; font-weight: 500; }\n.med-tracker { background: var(--surface2); border-radius: 11px; padding: 13px 15px; border: 1px solid var(--border); }\n.med-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 9px; }\n.med-count { font-size: 24px; font-weight: 700; font-family: var(--mono); }\n.med-sub { font-size: 11px; color: var(--text2); margin-top: 1px; }\n.med-bar-track { height: 8px; background: var(--border); border-radius: 99px; overflow: hidden; margin-bottom: 7px; }\n.med-bar-fill { height: 100%; border-radius: 99px; }\n.med-bar-fill.ok { background: var(--ok); }\n.med-bar-fill.warn { background: var(--warn); }\n.med-bar-fill.danger { background: var(--danger); }\n.med-stats { display: flex; gap: 10px; font-size: 11px; color: var(--text2); flex-wrap: wrap; }\n.med-alert { display: flex; gap: 7px; align-items: flex-start; border-radius: 9px; padding: 9px 11px; font-size: 12px; margin-top: 9px; line-height: 1.5; }\n.med-alert.ok { background: var(--ok-light); color: #14532d; }\n.med-alert.warn { background: var(--warn-light); color: #78350f; }\n.med-alert.danger { background: var(--danger-light); color: #7f1d1d; }\n.update-row { display: flex; gap: 7px; align-items: center; margin-top: 12px; }\n.update-row input { flex: 1; padding: 9px 11px; border: 1.5px solid var(--border); border-radius: 8px; font-family: var(--mono); font-size: 14px; outline: none; -webkit-appearance: none; }\n.update-row input:focus { border-color: var(--accent); }\n.btn-sm { padding: 9px 13px; border-radius: 8px; font-family: var(--sans); font-size: 12px; font-weight: 700; cursor: pointer; border: none; }\n.btn-sm.green { background: var(--accent); color: #fff; }\n.btn-sm.red { background: var(--danger-light); color: var(--danger); }\n.btn-sm.gray { background: var(--bg); color: var(--text2); border: 1px solid var(--border); }\n.panel-footer { padding: 12px 20px; border-top: 1px solid var(--border); display: flex; gap: 7px; background: var(--surface2); }\n\n\/* MODAL *\/\n.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.45); display: none; align-items: flex-end; justify-content: center; z-index: 200; }\n@media(min-width:600px){ .modal-overlay { align-items: center; padding: 20px; } }\n.modal { background: #fff; border-radius: 20px 20px 0 0; width: 100%; max-width: 580px; max-height: 94vh; overflow-y: auto; -webkit-overflow-scrolling: touch; box-shadow: 0 -8px 40px rgba(0,0,0,.2); }\n@media(min-width:600px){ .modal { border-radius: 20px; max-height: 92vh; box-shadow: 0 40px 100px rgba(0,0,0,.3); } }\n.modal-header { padding: 20px 24px 0; display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }\n.modal-header h2 { font-size: 17px; font-weight: 700; }\n.modal-close { width: 30px; height: 30px; border: none; background: var(--bg); border-radius: 7px; cursor: pointer; font-size: 16px; color: var(--text2); }\n.modal-body { padding: 0 24px 32px; }\n.form-section { margin-bottom: 16px; }\n.form-section-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; color: var(--text3); margin-bottom: 9px; padding-bottom: 7px; border-bottom: 1px solid var(--border); }\n.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 11px; }\n.form-grid .full { grid-column: 1\/-1; }\n.form-field label { display: block; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .05em; color: var(--text2); margin-bottom: 4px; }\n.form-field input, .form-field select { width: 100%; padding: 10px 11px; border: 1.5px solid var(--border); border-radius: 9px; font-family: var(--sans); font-size: 14px; outline: none; background: var(--surface2); color: var(--text); -webkit-appearance: none; }\n.form-field input:focus, .form-field select:focus { border-color: var(--accent); background: #fff; }\n.hint { font-size: 11px; color: var(--text3); margin-top: 3px; }\n.modal-footer { display: flex; gap: 9px; justify-content: flex-end; border-top: 1px solid var(--border); margin-top: 16px; padding-top: 16px; }\n.btn-cancel { padding: 10px 16px; background: var(--bg); border: none; border-radius: 8px; font-family: var(--sans); font-size: 13px; font-weight: 500; cursor: pointer; color: var(--text2); }\n\n\/* PATIENT VIEW *\/\n.patient-topbar { background: var(--accent); padding: 0 20px; height: 56px; display: flex; align-items: center; justify-content: space-between; }\n.pt-tb-left span { color: #fff; font-weight: 700; font-size: 15px; display: block; }\n.pt-tb-left small { color: rgba(255,255,255,.6); font-size: 11px; font-family: var(--mono); }\n.pt-logout { background: rgba(255,255,255,.18); color: #fff; border: none; padding: 7px 12px; border-radius: 7px; font-size: 12px; cursor: pointer; font-weight: 600; }\n.pt-content { padding: 16px; max-width: 500px; margin: 0 auto; }\n.pt-card { background: #fff; border-radius: var(--radius); border: 1px solid var(--border); padding: 18px; margin-bottom: 12px; box-shadow: var(--shadow); }\n.pt-card h2 { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; color: var(--text3); margin-bottom: 12px; }\n.pt-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; }\n.pt-row:last-child { border-bottom: none; }\n.pt-row-key { color: var(--text2); }\n.pt-row-val { font-weight: 600; }\n.ring-wrap { display: flex; align-items: center; gap: 16px; }\n.ring-svg { width: 84px; height: 84px; flex-shrink: 0; }\n.ring-bg { fill: none; stroke: var(--border); stroke-width: 9; }\n.ring-fill { fill: none; stroke-width: 9; stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; }\n.ring-text { text-anchor: middle; dominant-baseline: middle; font-family: var(--mono); font-size: 13px; font-weight: 700; fill: var(--text); }\n.ring-info h3 { font-size: 20px; font-weight: 700; font-family: var(--mono); }\n.ring-info p { font-size: 12px; color: var(--text2); margin-top: 2px; }\n.ring-info .wk { font-size: 13px; font-weight: 700; color: var(--accent); margin-top: 5px; }\n.pt-tl-track { height: 10px; background: var(--border); border-radius: 99px; display: flex; overflow: hidden; margin-bottom: 7px; }\n.pt-tl-p1 { background: var(--phase1); height: 100%; }\n.pt-tl-p2 { background: var(--phase2); height: 100%; }\n.pt-tl-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--text3); }\n.pt-phase-blocks { display: grid; grid-template-columns: 1fr 1fr; gap: 9px; margin-top: 11px; }\n.pt-phase-block { border-radius: 10px; padding: 11px 13px; }\n.pb-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .05em; margin-bottom: 4px; }\n.pb-med { font-size: 15px; font-weight: 700; font-family: var(--mono); }\n.pb-sub { font-size: 11px; margin-top: 2px; opacity: .8; }\n\n\/* Mobile table hide columns *\/\n@media(max-width:600px){\n  thead th:nth-child(3),tbody td:nth-child(3),\n  thead th:nth-child(5),tbody td:nth-child(5),\n  thead th:nth-child(7),tbody td:nth-child(7){ display:none; }\n  .form-grid { grid-template-columns: 1fr; }\n  .form-grid .full { grid-column: 1; }\n}\n\n\/* Tooltip on SVG map *\/\n.map-tooltip { position: absolute; background: rgba(17,24,39,.9); color: #fff; font-size: 12px; padding: 6px 10px; border-radius: 7px; pointer-events: none; display: none; z-index: 10; white-space: nowrap; line-height: 1.5; }\n<\/style>\n<\/head>\n<body>\n\n<!-- ═══ LOGIN ═══ -->\n<div id=\"login-screen\">\n  <div class=\"login-card\">\n    <div class=\"login-mark\">\n      <div class=\"login-mark-icon\"><svg viewBox=\"0 0 24 24\"><path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z\"\/><\/svg><\/div>\n      <div><div class=\"lm-title\">TB Care Program<\/div><div class=\"lm-sub\">NINAWA · HEALTH DIRECTORATE<\/div><\/div>\n    <\/div>\n    <div class=\"tab-row\">\n      <button class=\"tab-btn active\" onclick=\"setTab('admin')\">Admin<\/button>\n      <button class=\"tab-btn\" onclick=\"setTab('patient')\">Patient<\/button>\n    <\/div>\n    <div id=\"admin-login-form\">\n      <div class=\"field\"><label>Username<\/label><input type=\"text\" id=\"admin-user\" placeholder=\"admin\" autocomplete=\"off\" autocapitalize=\"none\"><\/div>\n      <div class=\"field\"><label>Password<\/label><input type=\"password\" id=\"admin-pass\" placeholder=\"••••••••\"><\/div>\n      <button class=\"btn-primary\" onclick=\"adminLogin()\">Sign In<\/button>\n    <\/div>\n    <div id=\"patient-login-form\" style=\"display:none\">\n      <div class=\"field\"><label>Patient Code<\/label><input type=\"text\" id=\"pt-code-inp\" placeholder=\"e.g. NNW-081\" autocomplete=\"off\" style=\"font-family:var(--mono);letter-spacing:.06em\"><\/div>\n      <button class=\"btn-primary\" onclick=\"patientLogin()\">Access My Records<\/button>\n    <\/div>\n    <div class=\"login-error\" id=\"login-error\">Incorrect credentials. Please try again.<\/div>\n  <\/div>\n<\/div>\n\n<!-- ═══ APP ═══ -->\n<div id=\"app\">\n\n<!-- ADMIN -->\n<div id=\"admin-view\">\n  <div class=\"topbar\">\n    <div class=\"topbar-brand\">\n      <div class=\"topbar-icon\"><svg viewBox=\"0 0 24 24\" fill=\"white\"><path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z\"\/><\/svg><\/div>\n      <div><div class=\"topbar-title\">TB Care · Ninawa<\/div><div class=\"topbar-sub\">ADMIN DASHBOARD<\/div><\/div>\n    <\/div>\n    <div class=\"topbar-right\">\n      <span class=\"chip\">SAIF<\/span>\n      <button class=\"btn-ghost\" onclick=\"logout()\">Logout<\/button>\n    <\/div>\n  <\/div>\n  <div class=\"admin-content\">\n    <div class=\"stats-grid\" id=\"stats-grid\"><\/div>\n    <div class=\"alerts-banner\" id=\"alerts-banner\"><\/div>\n\n",
  "stderr" : ""
}{
  "returncode" : 0,
  "stdout" : "    <!-- SVG MAP -->\n    <div class=\"map-card\">\n      <div class=\"map-header\">\n        <div><h3>District TB Distribution · Ninawa<\/h3><p>Active cases by sector — tap a district to filter<\/p><\/div>\n        <div class=\"map-legend\">\n          <div class=\"legend-item\"><div class=\"legend-dot\" style=\"background:#dc2626\"><\/div>High (5+)<\/div>\n          <div class=\"legend-item\"><div class=\"legend-dot\" style=\"background:#d97706\"><\/div>Med (2–4)<\/div>\n          <div class=\"legend-item\"><div class=\"legend-dot\" style=\"background:#16a34a\"><\/div>Low (1)<\/div>\n        <\/div>\n      <\/div>\n      <div class=\"map-body\">\n        <div id=\"svg-map-wrap\">\n          <svg id=\"ninawa-svg\" viewBox=\"0 0 500 380\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" style=\"cursor:pointer\">\n            <!-- Background -->\n            <rect width=\"500\" height=\"380\" fill=\"#dde8dd\"\/>\n            <!-- Ninawa border shape (approximate outline) -->\n            <path d=\"M60,50 L160,30 L260,20 L360,40 L440,80 L460,140 L450,200 L440,260 L400,320 L340,350 L260,360 L180,350 L110,320 L70,270 L50,200 L45,140 Z\" fill=\"#c8dbc8\" stroke=\"#9ab89a\" stroke-width=\"2\"\/>\n            <!-- River Tigris (approximate) -->\n            <path d=\"M200,25 Q220,60 210,100 Q200,140 215,180 Q225,210 220,250 Q215,280 230,320\" fill=\"none\" stroke=\"#7ab3d4\" stroke-width=\"4\" stroke-linecap=\"round\" opacity=\".7\"\/>\n\n            <!-- District regions (clickable) -->\n            <!-- Mosul - center -->\n            <ellipse id=\"dist-Mosul\" cx=\"215\" cy=\"155\" rx=\"52\" ry=\"44\" fill=\"#c8dbc8\" stroke=\"#9ab89a\" stroke-width=\"1.5\" class=\"dist-shape\" data-district=\"Mosul\"\/>\n            <text x=\"215\" y=\"152\" text-anchor=\"middle\" font-size=\"10\" fill=\"#1a3a1a\" font-family=\"sans-serif\" font-weight=\"600\" pointer-events=\"none\">Mosul<\/text>\n\n            <!-- Tilkaif - north of Mosul -->\n            <ellipse id=\"dist-Tilkaif\" cx=\"230\" cy=\"90\" rx=\"38\" ry=\"30\" fill=\"#c8dbc8\" stroke=\"#9ab89a\" stroke-width=\"1.5\" class=\"dist-shape\" data-district=\"Tilkaif\"\/>\n            <text x=\"230\" y=\"87\" text-anchor=\"middle\" font-size=\"9\" fill=\"#1a3a1a\" font-family=\"sans-serif\" font-weight=\"600\" pointer-events=\"none\">Tilkaif<\/text>\n\n            <!-- Shekhan - northeast -->\n            <ellipse id=\"dist-Shekhan\" cx=\"340\" cy=\"90\" rx=\"38\" ry=\"30\" fill=\"#c8dbc8\" stroke=\"#9ab89a\" stroke-width=\"1.5\" class=\"dist-shape\" data-district=\"Shekhan\"\/>\n            <text x=\"340\" y=\"87\" text-anchor=\"middle\" font-size=\"9\" fill=\"#1a3a1a\" font-family=\"sans-serif\" font-weight=\"600\" pointer-events=\"none\">Shekhan<\/text>\n\n            <!-- Tal Afar - west -->\n            <ellipse id=\"dist-TalAfar\" cx=\"110\" cy=\"160\" rx=\"40\" ry=\"32\" fill=\"#c8dbc8\" stroke=\"#9ab89a\" stroke-width=\"1.5\" class=\"dist-shape\" data-district=\"Tal Afar\"\/>\n            <text x=\"110\" y=\"157\" text-anchor=\"middle\" font-size=\"9\" fill=\"#1a3a1a\" font-family=\"sans-serif\" font-weight=\"600\" pointer-events=\"none\">Tal Afar<\/text>\n\n            <!-- Hamdaniya - east of Mosul -->\n            <ellipse id=\"dist-Hamdaniya\" cx=\"340\" cy=\"170\" rx=\"42\" ry=\"30\" fill=\"#c8dbc8\" stroke=\"#9ab89a\" stroke-width=\"1.5\" class=\"dist-shape\" data-district=\"Hamdaniya\"\/>\n            <text x=\"340\" y=\"167\" text-anchor=\"middle\" font-size=\"9\" fill=\"#1a3a1a\" font-family=\"sans-serif\" font-weight=\"600\" pointer-events=\"none\">Hamdaniya<\/text>\n\n            <!-- Sinjar - southwest -->\n            <ellipse id=\"dist-Sinjar\" cx=\"105\" cy=\"250\" rx=\"44\" ry=\"32\" fill=\"#c8dbc8\" stroke=\"#9ab89a\" stroke-width=\"1.5\" class=\"dist-shape\" data-district=\"Sinjar\"\/>\n            <text x=\"105\" y=\"247\" text-anchor=\"middle\" font-size=\"9\" fill=\"#1a3a1a\" font-family=\"sans-serif\" font-weight=\"600\" pointer-events=\"none\">Sinjar<\/text>\n\n            <!-- Rabia - northwest -->\n            <ellipse id=\"dist-Rabia\" cx=\"150\" cy=\"60\" rx=\"36\" ry=\"26\" fill=\"#c8dbc8\" stroke=\"#9ab89a\" stroke-width=\"1.5\" class=\"dist-shape\" data-district=\"Rabia\"\/>\n            <text x=\"150\" y=\"58\" text-anchor=\"middle\" font-size=\"9\" fill=\"#1a3a1a\" font-family=\"sans-serif\" font-weight=\"600\" pointer-events=\"none\">Rabia<\/text>\n\n            <!-- Zummar - north -->\n            <ellipse id=\"dist-Zummar\" cx=\"80\" cy=\"105\" rx=\"32\" ry=\"24\" fill=\"#c8dbc8\" stroke=\"#9ab89a\" stroke-width=\"1.5\" class=\"dist-shape\" data-district=\"Zummar\"\/>\n            <text x=\"80\" y=\"103\" text-anchor=\"middle\" font-size=\"9\" fill=\"#1a3a1a\" font-family=\"sans-serif\" font-weight=\"600\" pointer-events=\"none\">Zummar<\/text>\n\n            <!-- Makhmur - southeast -->\n            <ellipse id=\"dist-Makhmur\" cx=\"360\" cy=\"280\" rx=\"44\" ry=\"32\" fill=\"#c8dbc8\" stroke=\"#9ab89a\" stroke-width=\"1.5\" class=\"dist-shape\" data-district=\"Makhmur\"\/>\n            <text x=\"360\" y=\"277\" text-anchor=\"middle\" font-size=\"9\" fill=\"#1a3a1a\" font-family=\"sans-serif\" font-weight=\"600\" pointer-events=\"none\">Makhmur<\/text>\n\n            <!-- Qa Qaa - south -->\n            <ellipse id=\"dist-QaQaa\" cx=\"255\" cy=\"300\" rx=\"46\" ry=\"32\" fill=\"#c8dbc8\" stroke=\"#9ab89a\" stroke-width=\"1.5\" class=\"dist-shape\" data-district=\"Qa Qaa\"\/>\n            <text x=\"255\" y=\"297\" text-anchor=\"middle\" font-size=\"9\" fill=\"#1a3a1a\" font-family=\"sans-serif\" font-weight=\"600\" pointer-events=\"none\">Qa Qaa<\/text>\n\n            <!-- Baaj - far southwest -->\n            <ellipse id=\"dist-Baaj\" cx=\"90\" cy=\"320\" rx=\"36\" ry=\"26\" fill=\"#c8dbc8\" stroke=\"#9ab89a\" stroke-width=\"1.5\" class=\"dist-shape\" data-district=\"Baaj\"\/>\n            <text x=\"90\" y=\"318\" text-anchor=\"middle\" font-size=\"9\" fill=\"#1a3a1a\" font-family=\"sans-serif\" font-weight=\"600\" pointer-events=\"none\">Baaj<\/text>\n\n            <!-- Akre - far northeast -->\n            <ellipse id=\"dist-Akre\" cx=\"430\" cy=\"120\" rx=\"36\" ry=\"26\" fill=\"#c8dbc8\" stroke=\"#9ab89a\" stroke-width=\"1.5\" class=\"dist-shape\" data-district=\"Akre\"\/>\n            <text x=\"430\" y=\"118\" text-anchor=\"middle\" font-size=\"9\" fill=\"#1a3a1a\" font-family=\"sans-serif\" font-weight=\"600\" pointer-events=\"none\">Akre<\/text>\n\n            <!-- Case count bubbles (rendered by JS) -->\n            <g id=\"map-bubbles\"><\/g>\n          <\/svg>\n          <div class=\"map-tooltip\" id=\"map-tooltip\"><\/div>\n        <\/div>\n        <div class=\"district-sidebar\" id=\"district-sidebar\"><\/div>\n      <\/div>\n    <\/div>\n\n    <!-- TABLE -->\n    <div class=\"table-card\">\n      <div class=\"table-toolbar\">\n        <div class=\"search-wrap\">\n          <svg class=\"search-icon\" width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\"><circle cx=\"11\" cy=\"11\" r=\"8\"\/><path d=\"m21 21-4.35-4.35\"\/><\/svg>\n          <input type=\"text\" placeholder=\"Search name or code…\" oninput=\"renderTable()\" id=\"search-inp\">\n        <\/div>\n        <div class=\"toolbar-right\">\n          <select class=\"filter-sel\" id=\"phase-filter\" onchange=\"renderTable()\">\n            <option value=\"\">All Phases<\/option>\n            <option value=\"Intensive\">Intensive<\/option>\n            <option value=\"Continuation\">Continuation<\/option>\n            <option value=\"Completed\">Completed<\/option>\n          <\/select>\n          <select class=\"filter-sel\" id=\"alert-filter\" onchange=\"renderTable()\">\n            <option value=\"\">All<\/option>\n            <option value=\"alert\">Alerts Only<\/option>\n          <\/select>\n          <button class=\"btn-accent\" onclick=\"openAddModal()\">+ New Patient<\/button>\n        <\/div>\n      <\/div>\n      <div style=\"overflow-x:auto\">\n        <table>\n          <thead><tr>\n            <th>Code<\/th><th>Name<\/th><th>Age\/Sex<\/th>\n            <th>Phase<\/th><th>Start<\/th><th>Drug<\/th>\n            <th>Refill In<\/th><th>Supply<\/th>\n          <\/tr><\/thead>\n          <tbody id=\"patients-tbody\"><\/tbody>\n        <\/table>\n        <div class=\"empty-state\" id=\"empty-state\" style=\"display:none\">No patients found. Register your first patient above.<\/div>\n      <\/div>\n    <\/div>\n  <\/div>\n<\/div>\n\n<!-- PATIENT -->\n<div id=\"patient-view\">\n  <div class=\"patient-topbar\">\n    <div class=\"pt-tb-left\"><span id=\"pt-greeting\">—<\/span><small id=\"pt-code-display\">—<\/small><\/div>\n    <button class=\"pt-logout\" onclick=\"logout()\">Logout<\/button>\n  <\/div>\n  <div class=\"pt-content\" id=\"pt-content\"><\/div>\n<\/div>\n\n<\/div><!-- #app -->\n\n<!-- PANEL OVERLAY -->\n<div class=\"panel-overlay\" id=\"panel-overlay\" onclick=\"closePanel()\"><\/div>\n<div class=\"detail-panel\" id=\"detail-panel\">\n  <div class=\"panel-header\">\n    <div class=\"panel-htop\">\n      <div><div class=\"panel-name\" id=\"panel-name\"><\/div><div class=\"panel-meta\" id=\"panel-meta\"><\/div><\/div>\n      <button class=\"panel-close\" onclick=\"closePanel()\">✕<\/button>\n    <\/div>\n  <\/div>\n  <div class=\"timeline-wrap\" id=\"panel-timeline\"><\/div>\n  <div class=\"panel-body\" id=\"panel-body\"><\/div>\n  <div class=\"panel-footer\" id=\"panel-footer\"><\/div>\n<\/div>\n\n<!-- MODAL -->\n<div class=\"modal-overlay\" id=\"modal-overlay\">\n  <div class=\"modal\">\n    <div class=\"modal-header\"><h2 id=\"modal-title\">Register New Patient<\/h2><button class=\"modal-close\" onclick=\"closeModal()\">✕<\/button><\/div>\n    <div class=\"modal-body\">\n      <div class=\"form-section\">\n        <div class=\"form-section-title\">Patient Information<\/div>\n        <div class=\"form-grid\">\n          <div class=\"form-field full\"><label>Full Name<\/label><input type=\"text\" id=\"f-name\" placeholder=\"Patient full name\"><\/div>\n          <div class=\"form-field\"><label>Patient Code<\/label><input type=\"text\" id=\"f-code\" placeholder=\"NNW-001\" style=\"font-family:var(--mono)\"><div class=\"hint\">Must be unique<\/div><\/div>\n          <div class=\"form-field\"><label>Age<\/label><input type=\"number\" id=\"f-age\" placeholder=\"35\"><\/div>\n          <div class=\"form-field\"><label>Gender<\/label><select id=\"f-gender\"><option value=\"\">Select<\/option><option>Male<\/option><option>Female<\/option><\/select><\/div>\n          <div class=\"form-field\"><label>Phone<\/label><input type=\"text\" id=\"f-phone\" placeholder=\"+964 7XX XXX XXXX\"><\/div>\n          <div class=\"form-field\"><label>Sector \/ District<\/label>\n            <select id=\"f-sector\">\n              <option value=\"\">Select district<\/option>\n              <option>Mosul<\/option><option>Tal Afar<\/option><option>Sinjar<\/option>\n              <option>Baaj<\/option><option>Rabia<\/option><option>Tilkaif<\/option>\n              <option>Hamdaniya<\/option><option>Shekhan<\/option><option>Akre<\/option>\n              <option>Makhmur<\/option><option>Qa Qaa<\/option><option>Zummar<\/option>\n              <option value=\"other\">Other<\/option>\n            <\/select>\n          <\/div>\n        <\/div>\n      <\/div>\n      <div class=\"form-section\">\n        <div class=\"form-section-title\">TB Classification<\/div>\n        <div class=\"form-grid\">\n          <div class=\"form-field\"><label>TB Site<\/label><select id=\"f-site\"><option value=\"\">Select<\/option><option value=\"Pulmonary\">Pulmonary (رئوي)<\/option><option value=\"Extrapulmonary\">Extrapulmonary (خارج الرئة)<\/option><\/select><\/div>\n          <div class=\"form-field\"><label>Patient Category<\/label><select id=\"f-category\"><option value=\"New\">New Case<\/option><option value=\"Retreatment\">Retreatment<\/option><\/select><\/div>\n          <div class=\"form-field\"><label>Smear Result<\/label><select id=\"f-smear\"><option value=\"\">Select<\/option><option value=\"Positive\">Positive (+)<\/option><option value=\"Negative\">Negative (-)<\/option><option value=\"Not done\">Not done<\/option><\/select><\/div>\n          <div class=\"form-field\"><label>Health Center<\/label><input type=\"text\" id=\"f-center\" placeholder=\"Center name\"><\/div>\n        <\/div>\n      <\/div>\n      <div class=\"form-section\">\n        <div class=\"form-section-title\">Treatment Plan · 6 Months Total<\/div>\n        <div class=\"form-grid\">\n          <div class=\"form-field\"><label>Treatment Start Date<\/label><input type=\"date\" id=\"f-start\"><\/div>\n          <div class=\"form-field\"><label>Intensive Drug (Months 1–2)<\/label><select id=\"f-drug1\"><option value=\"RHZE\">RHZE (Standard)<\/option><option value=\"Other\">Other<\/option><\/select><\/div>\n          <div class=\"form-field\"><label>Continuation Drug (Months 3–6)<\/label><select id=\"f-drug2\"><option value=\"RH\">RH (Standard)<\/option><option value=\"RHE\">RHE<\/option><option value=\"Other\">Other<\/option><\/select><\/div>\n          <div class=\"form-field\"><label>Daily Dose (tablets\/day)<\/label><input type=\"number\" id=\"f-daily\" placeholder=\"4\"><\/div>\n        <\/div>\n      <\/div>\n      <div class=\"form-section\">\n        <div class=\"form-section-title\">Medication Stock<\/div>\n        <div class=\"form-grid\">\n          <div class=\"form-field\"><label>Total Tablets Dispensed<\/label><input type=\"number\" id=\"f-total\" placeholder=\"56\"><\/div>\n          <div class=\"form-field\"><label>Tablets Currently Remaining<\/label><input type=\"number\" id=\"f-remaining\" placeholder=\"56\"><\/div>\n          <div class=\"form-field full\"><label>Clinical Notes<\/label><input type=\"text\" id=\"f-notes\" placeholder=\"Optional notes...\"><\/div>\n        <\/div>\n      <\/div>\n      <div class=\"modal-footer\">\n        <button class=\"btn-cancel\" onclick=\"closeModal()\">Cancel<\/button>\n        <button class=\"btn-accent\" onclick=\"savePatient()\">Save Patient<\/button>\n      <\/div>\n    <\/div>\n  <\/div>\n<\/div>\n\n<script>\n\/\/ ── CONFIG ──────────────────────────────\nconst ADMIN_USER = 'saif';\nconst ADMIN_PASS = 'tb2024!secure';\nconst INTENSIVE_DAYS = 60;\nconst TOTAL_DAYS = 180;\n\n\/\/ District → SVG element ID mapping\nconst DIST_IDS = {\n  'mosul':'dist-Mosul','tal afar':'dist-TalAfar','sinjar':'dist-Sinjar',\n  'baaj':'dist-Baaj','rabia':'dist-Rabia','tilkaif':'dist-Tilkaif',\n  'hamdaniya':'dist-Hamdaniya','shekhan':'dist-Shekhan','akre':'dist-Akre',\n  'makhmur':'dist-Makhmur','qa qaa':'dist-QaQaa','zummar':'dist-Zummar'\n};\n\n\/\/ Bubble center positions (cx,cy) matching SVG ellipses\nconst DIST_CENTERS = {\n  'mosul':[215,155],'tal afar':[110,160],'sinjar':[105,250],\n  'baaj':[90,320],'rabia':[150,60],'tilkaif':[230,90],\n  'hamdaniya':[340,170],'shekhan':[340,90],'akre':[430,120],\n  'makhmur':[360,280],'qa qaa':[255,300],'zummar':[80,105]\n};\n\nlet patients = [];\ntry { patients = JSON.parse(localStorage.getItem('tb_patients_v2') || '[]'); } catch(e){}\nlet editingId = null;\n\nfunction save() {\n  try { localStorage.setItem('tb_patients_v2', JSON.stringify(patients)); } catch(e){}\n}\n\n\/\/ ── HELPERS ─────────────────────────────\nfunction daysSince(ds) {\n  if (!ds) return 0;\n  return Math.floor((Date.now() - new Date(ds).getTime()) \/ 86400000);\n}\nfunction autoPhase(pt) {\n  if (!pt.startDate) return 'Intensive';\n  const d = daysSince(pt.startDate);\n  if (d >= TOTAL_DAYS) return 'Completed';\n  if (d >= INTENSIVE_DAYS) return 'Continuation';\n  return 'Intensive';\n}\nfunction currentDrug(pt) {\n  const p = autoPhase(pt);\n  return p==='Intensive'?(pt.drug1||'RHZE'):p==='Continuation'?(pt.drug2||'RH'):'—';\n}\nfunction daysLeft(pt) {\n  if (!pt.startDate) return null;\n  return Math.max(0, TOTAL_DAYS - daysSince(pt.startDate));\n}\nfunction medStatus(pt) {\n  const r=pt.remaining||0, t=pt.total||0;\n  if (r<=0||t<=0) return 'empty';\n  const p=r\/t;\n  if (p<=0.1) return 'critical';\n  if (p<=0.25) return 'low';\n  return 'ok';\n}\nfunction refillDays(pt) {\n  if (!pt.daily||!pt.remaining) return null;\n  return Math.floor(pt.remaining\/pt.daily);\n}\nfunction fmtDate(s) {\n  if (!s) return '—';\n  try { return new Date(s).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}); }\n  catch(e){ return s; }\n}\nfunction addDays(ds, n) {\n  if (!ds) return null;\n  const d = new Date(ds); d.setDate(d.getDate()+n);\n  return d.toISOString().split('T')[0];\n}\nfunction normDist(s) {\n  return (s||'').trim().toLowerCase();\n}\n\n\/\/ ── LOGIN ────────────────────────────────\nfunction setTab(t) {\n  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',(i===0&&t==='admin')||(i===1&&t==='patient')));\n  document.getElementById('admin-login-form').style.display=t==='admin'?'block':'none';\n  document.getElementById('patient-login-form').style.display=t==='patient'?'block':'none';\n  document.getElementById('login-error').style.display='none';\n}\nfunction showErr(msg) {\n  const el=document.getElementById('login-error');\n  el.textContent=msg||'Incorrect credentials.';\n  el.style.display='block';\n  setTimeout(()=>el.style.display='none',3500);\n}\nfunction adminLogin() {\n  const u=document.getElementById('admin-user').value.trim().toLowerCase();\n  const p=document.getElementById('admin-pass').value;\n  if(u===ADMIN_USER&&p===ADMIN_PASS) showApp('admin');\n  else showErr();\n}\nfunction patientLogin() {\n  const code=document.getElementById('pt-code-inp').value.trim().toUpperCase();\n  const pt=patients.find(p=>p.code.toUpperCase()===code);\n  if(pt) showApp('patient',pt);\n  else showErr('Patient code not found.');\n}\n",
  "stderr" : ""
}{
  "returncode" : 0,
  "stdout" : "function showApp(role,pt) {\n  document.getElementById('login-screen').style.display='none';\n  document.getElementById('app').style.display='block';\n  document.getElementById('admin-view').style.display=role==='admin'?'block':'none';\n  document.getElementById('patient-view').style.display=role==='patient'?'block':'none';\n  if(role==='admin'){ renderStats();renderAlerts();renderMap();renderTable(); }\n  else renderPatientView(pt);\n}\nfunction logout() {\n  document.getElementById('app').style.display='none';\n  document.getElementById('login-screen').style.display='flex';\n  ['admin-user','admin-pass','pt-code-inp'].forEach(id=>document.getElementById(id).value='');\n  closePanel();\n}\ndocument.addEventListener('keydown',e=>{\n  if(e.key!=='Enter') return;\n  if(document.getElementById('admin-login-form').style.display!=='none') adminLogin();\n  else patientLogin();\n});\n\n\/\/ ── STATS ────────────────────────────────\nfunction renderStats() {\n  const tot=patients.length;\n  const intv=patients.filter(p=>autoPhase(p)==='Intensive').length;\n  const cont=patients.filter(p=>autoPhase(p)==='Continuation').length;\n  const alrt=patients.filter(p=>['critical','low','empty'].includes(medStatus(p))&&autoPhase(p)!=='Completed').length;\n  const comp=patients.filter(p=>autoPhase(p)==='Completed').length;\n  const soon=patients.filter(p=>{const r=refillDays(p);return r!==null&&r<=7&&autoPhase(p)!=='Completed';}).length;\n  document.getElementById('stats-grid').innerHTML=`\n    <div class=\"stat-card\"><div class=\"stat-label\">Total<\/div><div class=\"stat-val\">${tot}<\/div><\/div>\n    <div class=\"stat-card\"><div class=\"stat-label\">Intensive<\/div><div class=\"stat-val amber\">${intv}<\/div><\/div>\n    <div class=\"stat-card\"><div class=\"stat-label\">Continuation<\/div><div class=\"stat-val blue\">${cont}<\/div><\/div>\n    <div class=\"stat-card\"><div class=\"stat-label\">Alerts<\/div><div class=\"stat-val ${alrt>0?'red':'green'}\">${alrt}<\/div><\/div>\n    <div class=\"stat-card\"><div class=\"stat-label\">Refill ≤7d<\/div><div class=\"stat-val ${soon>0?'amber':'green'}\">${soon}<\/div><\/div>\n    <div class=\"stat-card\"><div class=\"stat-label\">Completed<\/div><div class=\"stat-val green\">${comp}<\/div><\/div>\n  `;\n}\n\n\/\/ ── ALERTS ───────────────────────────────\nfunction renderAlerts() {\n  const banner=document.getElementById('alerts-banner');\n  const items=[];\n  patients.forEach(pt=>{\n    if(autoPhase(pt)==='Completed') return;\n    const s=medStatus(pt),r=refillDays(pt);\n    if(s==='empty') items.push({pt,type:'danger',msg:`${pt.name} (${pt.code}) — Medication EMPTY. Resupply immediately.`});\n    else if(s==='critical') items.push({pt,type:'danger',msg:`${pt.name} (${pt.code}) — Critical: ${pt.remaining} tablets left (${r} days).`});\n    else if(s==='low') items.push({pt,type:'warn',msg:`${pt.name} (${pt.code}) — Low supply: ~${r} days remaining.`});\n    else if(r!==null&&r<=7) items.push({pt,type:'warn',msg:`${pt.name} (${pt.code}) — Refill due in ${r} days.`});\n  });\n  if(!items.length){banner.style.display='none';return;}\n  banner.style.display='block';\n  banner.innerHTML=items.map(i=>`\n    <div class=\"alert-item ${i.type==='warn'?'warn':''}\" onclick=\"openPanel('${i.pt.id}')\">\n      <div class=\"alert-dot ${i.type==='warn'?'warn':''}\"><\/div><span>${i.msg}<\/span>\n    <\/div>`).join('');\n}\n\n\/\/ ── MAP ──────────────────────────────────\nfunction renderMap() {\n  \/\/ Count active patients per district\n  const counts={};\n  patients.forEach(pt=>{\n    if(!pt.sector||autoPhase(pt)==='Completed') return;\n    const k=normDist(pt.sector);\n    counts[k]=(counts[k]||0)+1;\n  });\n\n  \/\/ Reset all district shapes\n  document.querySelectorAll('.dist-shape').forEach(el=>{\n    el.style.fill='#c8dbc8';\n    el.style.stroke='#9ab89a';\n  });\n\n  \/\/ Color districts by count\n  const bubbles=document.getElementById('map-bubbles');\n  bubbles.innerHTML='';\n\n  Object.entries(counts).forEach(([name,count])=>{\n    const color=count>=5?'#dc2626':count>=2?'#d97706':'#16a34a';\n    const fillLight=count>=5?'#fee2e2':count>=2?'#fef3c7':'#dcfce7';\n\n    \/\/ Color the shape\n    const elId=DIST_IDS[name];\n    if(elId){\n      const el=document.getElementById(elId);\n      if(el){el.style.fill=fillLight;el.style.stroke=color;}\n    }\n\n    \/\/ Add bubble\n    const center=DIST_CENTERS[name];\n    if(center){\n      const [cx,cy]=center;\n      const r=Math.max(14,Math.min(26,10+count*4));\n      const bubble=document.createElementNS('http:\/\/www.w3.org\/2000\/svg','circle');\n      bubble.setAttribute('cx',cx); bubble.setAttribute('cy',cy-28);\n      bubble.setAttribute('r',r); bubble.setAttribute('fill',color);\n      bubble.setAttribute('stroke','white'); bubble.setAttribute('stroke-width','2');\n      bubble.style.filter='drop-shadow(0 2px 4px rgba(0,0,0,.25))';\n      bubble.style.cursor='pointer';\n      bubbles.appendChild(bubble);\n\n      const label=document.createElementNS('http:\/\/www.w3.org\/2000\/svg','text');\n      label.setAttribute('x',cx); label.setAttribute('y',cy-24);\n      label.setAttribute('text-anchor','middle'); label.setAttribute('dominant-baseline','middle');\n      label.setAttribute('font-size',r>18?13:11); label.setAttribute('font-weight','700');\n      label.setAttribute('fill','white'); label.setAttribute('font-family','sans-serif');\n      label.setAttribute('pointer-events','none');\n      label.textContent=count;\n      bubbles.appendChild(label);\n    }\n  });\n\n  \/\/ District shapes clickable\n  document.querySelectorAll('.dist-shape').forEach(el=>{\n    el.onclick=()=>{\n      const name=el.getAttribute('data-district');\n      document.getElementById('search-inp').value=name;\n      renderTable();\n      el.closest('.map-card').nextElementSibling?.scrollIntoView({behavior:'smooth',block:'start'});\n    };\n  });\n\n  \/\/ Tooltip on hover (desktop)\n  const tooltip=document.getElementById('map-tooltip');\n  const wrap=document.getElementById('svg-map-wrap');\n  document.querySelectorAll('.dist-shape').forEach(el=>{\n    const name=el.getAttribute('data-district');\n    const k=normDist(name);\n    const count=counts[k]||0;\n    el.addEventListener('mouseenter',e=>{\n      tooltip.innerHTML=`<strong>${name}<\/strong><br>Active cases: ${count}${count>0?'<br><span style=\"opacity:.7;font-size:11px\">Tap to filter table<\/span>':''}`;\n      tooltip.style.display='block';\n    });\n    el.addEventListener('mousemove',e=>{\n      const rect=wrap.getBoundingClientRect();\n      tooltip.style.left=(e.clientX-rect.left+10)+'px';\n      tooltip.style.top=(e.clientY-rect.top-10)+'px';\n    });\n    el.addEventListener('mouseleave',()=>tooltip.style.display='none');\n  });\n\n  \/\/ Sidebar list\n  const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]);\n  const sidebar=document.getElementById('district-sidebar');\n  if(!sorted.length){\n    sidebar.innerHTML='<div class=\"map-empty\">No active patients with districts assigned yet.<\/div>';\n    return;\n  }\n  const max=sorted[0][1];\n  sidebar.innerHTML=sorted.map(([name,count])=>{\n    const color=count>=5?'#dc2626':count>=2?'#d97706':'#16a34a';\n    const displayName=Object.keys(DIST_IDS).find(k=>k===name);\n    const label=name.charAt(0).toUpperCase()+name.slice(1);\n    return `<div class=\"dist-row\" onclick=\"filterByDistrict('${label}')\">\n      <span class=\"dist-name\">${label}<\/span>\n      <div class=\"dist-bar-wrap\"><div class=\"dist-bar\" style=\"width:${Math.round(count\/max*100)}%;background:${color}\"><\/div><\/div>\n      <span class=\"dist-count\" style=\"color:${color}\">${count}<\/span>\n    <\/div>`;\n  }).join('');\n}\n\nfunction filterByDistrict(name){\n  document.getElementById('search-inp').value=name;\n  renderTable();\n}\n\n\/\/ ── TABLE ────────────────────────────────\nfunction renderTable(){\n  const q=(document.getElementById('search-inp').value||'').toLowerCase();\n  const pf=document.getElementById('phase-filter').value;\n  const af=document.getElementById('alert-filter').value;\n  let list=patients.filter(pt=>{\n    const ph=autoPhase(pt),s=medStatus(pt);\n    if(q&&!pt.name.toLowerCase().includes(q)&&!pt.code.toLowerCase().includes(q)&&!(pt.sector||'').toLowerCase().includes(q)) return false;\n    if(pf&&ph!==pf) return false;\n    if(af==='alert'&&!['critical','low','empty'].includes(s)) return false;\n    return true;\n  });\n  const tbody=document.getElementById('patients-tbody');\n  document.getElementById('empty-state').style.display=list.length?'none':'block';\n  if(!list.length){tbody.innerHTML='';return;}\n  tbody.innerHTML=list.map(pt=>{\n    const ph=autoPhase(pt),s=medStatus(pt),r=refillDays(pt);\n    const phPill=ph==='Intensive'?`<span class=\"pill phase1\">Intensive<\/span>`\n      :ph==='Continuation'?`<span class=\"pill phase2\">Continuation<\/span>`\n      :`<span class=\"pill pdone\">✓ Done<\/span>`;\n    const supPill=s==='ok'?`<span class=\"pill med-ok\">OK<\/span>`\n      :s==='low'?`<span class=\"pill med-low\">Low<\/span>`\n      :(s==='critical'||s==='empty')?`<span class=\"pill med-crit\">${s==='empty'?'Empty':'Critical'}<\/span>`\n      :`<span class=\"pill neutral\">—<\/span>`;\n    const refillTxt=r===null?'—':r<=7?`<span style=\"color:var(--danger);font-weight:700\">${r}d ⚠<\/span>`\n      :r<=14?`<span style=\"color:var(--warn);font-weight:600\">${r}d<\/span>`:`${r}d`;\n    return `<tr onclick=\"openPanel('${pt.id}')\">\n      <td><span class=\"code-tag\">${pt.code}<\/span><\/td>\n      <td><strong>${pt.name}<\/strong><\/td>\n      <td>${pt.age||'—'}\/${pt.gender?pt.gender[0]:'—'}<\/td>\n      <td>${phPill}<\/td>\n      <td>${fmtDate(pt.startDate)}<\/td>\n      <td><span style=\"font-family:var(--mono);font-size:12px\">${currentDrug(pt)}<\/span><\/td>\n      <td>${refillTxt}<\/td>\n      <td>${supPill}<\/td>\n    <\/tr>`;\n  }).join('');\n}\n\n\/\/ ── PANEL ────────────────────────────────\nfunction openPanel(id){\n  const pt=patients.find(p=>p.id===id);\n  if(!pt) return;\n  const ph=autoPhase(pt);\n  const d=pt.startDate?daysSince(pt.startDate):0;\n  const iPct=Math.min(100,d>=INTENSIVE_DAYS?100:Math.round(d\/INTENSIVE_DAYS*100));\n  const cPct=d>=INTENSIVE_DAYS?Math.min(100,Math.round((d-INTENSIVE_DAYS)\/(TOTAL_DAYS-INTENSIVE_DAYS)*100)):0;\n  const dl=daysLeft(pt);\n  const contDate=addDays(pt.startDate,INTENSIVE_DAYS);\n  const endDate=addDays(pt.startDate,TOTAL_DAYS);\n\n  document.getElementById('panel-name').textContent=pt.name;\n  document.getElementById('panel-meta').innerHTML=`\n    <span class=\"pill ${ph==='Intensive'?'phase1':ph==='Continuation'?'phase2':'pdone'}\">${ph}<\/span>\n    <span class=\"code-tag\">${pt.code}<\/span>\n    ${pt.category?`<span class=\"pill neutral\">${pt.category}<\/span>`:''}\n    ${pt.site?`<span class=\"pill neutral\">${pt.site}<\/span>`:''}\n  `;\n\n  const p1w=iPct*(INTENSIVE_DAYS\/TOTAL_DAYS);\n  const p2w=cPct*((TOTAL_DAYS-INTENSIVE_DAYS)\/TOTAL_DAYS);\n  document.getElementById('panel-timeline').innerHTML=`\n    <div class=\"tl-label\"><span style=\"color:var(--phase1)\">Intensive · RHZE<\/span><span style=\"color:var(--phase2)\">Continuation · RH<\/span><\/div>\n    <div class=\"tl-track\"><div class=\"tl-p1\" style=\"width:${p1w}%\"><\/div><div class=\"tl-p2\" style=\"width:${p2w}%\"><\/div><\/div>\n    <div class=\"tl-months\"><span>Start<\/span><span>Month 2<\/span><span>Month 4<\/span><span>Month 6<\/span><\/div>\n    <div class=\"tl-info\">\n      <div class=\"tl-block\" style=\"background:var(--phase1-light)\"><div class=\"tv\" style=\"color:var(--phase1)\">${iPct}%<\/div><div class=\"tl\">Intensive<\/div><\/div>\n      <div class=\"tl-block\" style=\"background:var(--phase2-light)\"><div class=\"tv\" style=\"color:var(--phase2)\">${cPct}%<\/div><div class=\"tl\">Continuation<\/div><\/div>\n      <div class=\"tl-block\" style=\"background:var(--surface2);border:1px solid var(--border)\"><div class=\"tv\">${dl!==null?dl+'d':'—'}<\/div><div class=\"tl\">Days left<\/div><\/div>\n    <\/div>\n  `;\n\n  const rem=pt.remaining||0,tot=pt.total||0;\n  const pct=tot>0?Math.round(rem\/tot*100):0;\n  const s=medStatus(pt),r=refillDays(pt);\n  const barClass=s==='ok'?'ok':(s==='critical'||s==='empty')?'danger':'warn';\n  let alertHtml=s==='empty'\n    ?`<div class=\"med-alert danger\">⚠ Medication depleted — immediate resupply required.<\/div>`\n    :s==='critical'\n    ?`<div class=\"med-alert danger\">⚠ Critical — only ${r} days remaining.<\/div>`\n    :s==='low'\n    ?`<div class=\"med-alert warn\">⚠ Low supply — ~${r} days remaining. Schedule resupply.<\/div>`\n    :r!==null&&r<=7\n    ?`<div class=\"med-alert warn\">⚠ Refill due in ${r} days (${fmtDate(addDays(new Date().toISOString().split('T')[0],r))}).<\/div>`\n    :`<div class=\"med-alert ok\">✓ Supply adequate — ${r} days (${r!==null?Math.floor(r\/7):'?'} weeks).<\/div>`;\n\n  document.getElementById('panel-body').innerHTML=`\n    <div class=\"info-section\">\n      <div class=\"info-section-title\">Patient Information<\/div>\n      <div class=\"info-grid\">\n        <div class=\"info-cell\"><div class=\"info-key\">Age \/ Gender<\/div><div class=\"info-val\">${pt.age||'—'} \/ ${pt.gender||'—'}<\/div><\/div>\n        <div class=\"info-cell\"><div class=\"info-key\">Phone<\/div><div class=\"info-val\" style=\"font-family:var(--mono);font-size:12px\">${pt.phone||'—'}<\/div><\/div>\n        <div class=\"info-cell\"><div class=\"info-key\">Sector<\/div><div class=\"info-val\">${pt.sector||'—'}<\/div><\/div>\n        <div class=\"info-cell\"><div class=\"info-key\">Health Center<\/div><div class=\"info-val\">${pt.center||'—'}<\/div><\/div>\n        <div class=\"info-cell\"><div class=\"info-key\">TB Site<\/div><div class=\"info-val\">${pt.site||'—'}<\/div><\/div>\n        <div class=\"info-cell\"><div class=\"info-key\">Smear<\/div><div class=\"info-val\">${pt.smear||'—'}<\/div><\/div>\n        <div class=\"info-cell\"><div class=\"info-key\">Category<\/div><div class=\"info-val\">${pt.category||'—'}<\/div><\/div>\n        <div class=\"info-cell\"><div class=\"info-key\">Current Drug<\/div><div class=\"info-val\" style=\"font-family:var(--mono);font-weight:700\">${currentDrug(pt)}<\/div><\/div>\n        <div class=\"info-cell full\"><div class=\"info-key\">Treatment Period<\/div><div class=\"info-val\">${fmtDate(pt.startDate)} → ${fmtDate(endDate)} &nbsp;·&nbsp; Continuation from ${fmtDate(contDate)}<\/div><\/div>\n        ${pt.notes?`<div class=\"info-cell full\"><div class=\"info-key\">Notes<\/div><div class=\"info-val\">${pt.notes}<\/div><\/div>`:''}\n      <\/div>\n    <\/div>\n    <div class=\"info-section\">\n      <div class=\"info-section-title\">Medication Tracker<\/div>\n      <div class=\"med-tracker\">\n        <div class=\"med-top\">\n          <div><div class=\"med-count\">${rem} <span style=\"font-size:15px;color:var(--text2)\">\/ ${tot}<\/span><\/div><div class=\"med-sub\">tablets remaining<\/div><\/div>\n          <div style=\"text-align:right\"><div style=\"font-size:20px;font-weight:700;font-family:var(--mono);color:${s==='ok'?'var(--ok)':s==='low'?'var(--warn)':'var(--danger)'}\">${pct}%<\/div><div class=\"med-sub\">${pt.daily||'—'} tabs\/day<\/div><\/div>\n        <\/div>\n        <div class=\"med-bar-track\"><div class=\"med-bar-fill ${barClass}\" style=\"width:${pct}%\"><\/div><\/div>\n        <div class=\"med-stats\">\n          <span>Daily: ${pt.daily||'—'}<\/span>\n          <span>Weekly: ${pt.daily?pt.daily*7:'—'}<\/span>\n          ${r!==null?`<span>Runs out: ${fmtDate(addDays(new Date().toISOString().split('T')[0],r))}<\/span>`:''}\n        <\/div>\n        ${alertHtml}\n        <div class=\"update-row\">\n          <input type=\"number\" id=\"upd-inp\" value=\"${rem}\" placeholder=\"New count\" min=\"0\">\n          <button class=\"btn-sm green\" onclick=\"updateMeds('${pt.id}')\">Update<\/button>\n        <\/div>\n      <\/div>\n    <\/div>\n  `;\n\n  document.getElementById('panel-footer').innerHTML=`\n    <button class=\"btn-sm gray\" onclick=\"openEditModal('${pt.id}')\">✏ Edit<\/button>\n    <button class=\"btn-sm red\" onclick=\"deletePatient('${pt.id}')\">Delete<\/button>\n  `;\n\n  document.getElementById('panel-overlay').style.display='block';\n  document.getElementById('detail-panel').classList.add('open');\n}\n\n",
  "stderr" : ""
}{
  "returncode" : 0,
  "stdout" : "function closePanel(){\n  document.getElementById('detail-panel').classList.remove('open');\n  document.getElementById('panel-overlay').style.display='none';\n}\nfunction updateMeds(id){\n  const val=parseInt(document.getElementById('upd-inp').value);\n  if(isNaN(val)||val<0) return;\n  const pt=patients.find(p=>p.id===id);\n  if(!pt) return;\n  pt.remaining=val;\n  save();renderStats();renderAlerts();renderMap();renderTable();openPanel(id);\n}\nfunction deletePatient(id){\n  if(!confirm('Permanently delete this patient record?')) return;\n  patients=patients.filter(p=>p.id!==id);\n  save();renderStats();renderAlerts();renderMap();renderTable();closePanel();\n}\n\n\/\/ ── MODAL ────────────────────────────────\nfunction clearForm(){\n  ['name','phone','center','notes'].forEach(f=>document.getElementById('f-'+f).value='');\n  document.getElementById('f-age').value='';\n  document.getElementById('f-gender').value='';\n  document.getElementById('f-sector').value='';\n  document.getElementById('f-site').value='';\n  document.getElementById('f-category').value='New';\n  document.getElementById('f-smear').value='';\n  document.getElementById('f-drug1').value='RHZE';\n  document.getElementById('f-drug2').value='RH';\n  document.getElementById('f-daily').value='';\n  document.getElementById('f-total').value='';\n  document.getElementById('f-remaining').value='';\n  document.getElementById('f-start').value=new Date().toISOString().split('T')[0];\n  document.getElementById('f-code').value='';\n}\nfunction openAddModal(){\n  editingId=null;\n  document.getElementById('modal-title').textContent='Register New Patient';\n  clearForm();\n  document.getElementById('modal-overlay').style.display='flex';\n}\nfunction openEditModal(id){\n  const pt=patients.find(p=>p.id===id);\n  if(!pt) return;\n  editingId=id;\n  document.getElementById('modal-title').textContent='Edit Patient';\n  document.getElementById('f-name').value=pt.name||'';\n  document.getElementById('f-code').value=pt.code||'';\n  document.getElementById('f-age').value=pt.age||'';\n  document.getElementById('f-gender').value=pt.gender||'';\n  document.getElementById('f-phone').value=pt.phone||'';\n  document.getElementById('f-sector').value=pt.sector||'';\n  document.getElementById('f-site').value=pt.site||'';\n  document.getElementById('f-category').value=pt.category||'New';\n  document.getElementById('f-smear').value=pt.smear||'';\n  document.getElementById('f-center').value=pt.center||'';\n  document.getElementById('f-start').value=pt.startDate||'';\n  document.getElementById('f-drug1').value=pt.drug1||'RHZE';\n  document.getElementById('f-drug2').value=pt.drug2||'RH';\n  document.getElementById('f-daily').value=pt.daily||'';\n  document.getElementById('f-total').value=pt.total||'';\n  document.getElementById('f-remaining').value=pt.remaining||'';\n  document.getElementById('f-notes').value=pt.notes||'';\n  document.getElementById('modal-overlay').style.display='flex';\n}\nfunction closeModal(){ document.getElementById('modal-overlay').style.display='none'; }\nfunction savePatient(){\n  const name=document.getElementById('f-name').value.trim();\n  const code=document.getElementById('f-code').value.trim().toUpperCase();\n  if(!name){alert('Patient name is required.');return;}\n  if(!code){alert('Patient code is required.');return;}\n  const dup=patients.find(p=>p.code.toUpperCase()===code&&p.id!==editingId);\n  if(dup){alert('This patient code is already in use.');return;}\n  const data={\n    name,code,\n    age:document.getElementById('f-age').value,\n    gender:document.getElementById('f-gender').value,\n    phone:document.getElementById('f-phone').value.trim(),\n    sector:document.getElementById('f-sector').value,\n    site:document.getElementById('f-site').value,\n    category:document.getElementById('f-category').value,\n    smear:document.getElementById('f-smear').value,\n    center:document.getElementById('f-center').value.trim(),\n    startDate:document.getElementById('f-start').value,\n    drug1:document.getElementById('f-drug1').value,\n    drug2:document.getElementById('f-drug2').value,\n    daily:parseInt(document.getElementById('f-daily').value)||0,\n    total:parseInt(document.getElementById('f-total').value)||0,\n    remaining:parseInt(document.getElementById('f-remaining').value)||0,\n    notes:document.getElementById('f-notes').value.trim(),\n  };\n  if(editingId){\n    const idx=patients.findIndex(p=>p.id===editingId);\n    patients[idx]={...patients[idx],...data};\n  } else {\n    data.id='pt_'+Date.now();\n    patients.push(data);\n  }\n  save();closeModal();renderStats();renderAlerts();renderMap();renderTable();\n  if(editingId) openPanel(editingId);\n}\n\n\/\/ ── PATIENT VIEW ─────────────────────────\nfunction renderPatientView(pt){\n  document.getElementById('pt-greeting').textContent=pt.name;\n  document.getElementById('pt-code-display').textContent=pt.code;\n  const ph=autoPhase(pt),dl=daysLeft(pt);\n  const rem=pt.remaining||0,tot=pt.total||0;\n  const pct=tot>0?Math.round(rem\/tot*100):0;\n  const s=medStatus(pt),r=refillDays(pt);\n  const d=pt.startDate?daysSince(pt.startDate):0;\n  const iPct=Math.min(100,d>=INTENSIVE_DAYS?100:Math.round(d\/INTENSIVE_DAYS*100));\n  const cPct=d>=INTENSIVE_DAYS?Math.min(100,Math.round((d-INTENSIVE_DAYS)\/(TOTAL_DAYS-INTENSIVE_DAYS)*100)):0;\n  const ringColor=s==='ok'?'#16a34a':(s==='critical'||s==='empty')?'#dc2626':'#d97706';\n  const C=2*Math.PI*34;\n  const offset=C-(C*pct\/100);\n  const contDate=addDays(pt.startDate,INTENSIVE_DAYS);\n  const endDate=addDays(pt.startDate,TOTAL_DAYS);\n  let alertMsg=s==='empty'\n    ?`<div class=\"med-alert danger\" style=\"margin-top:0\">⚠ Your medication has run out. Contact your health worker immediately.<\/div>`\n    :s==='critical'\n    ?`<div class=\"med-alert danger\" style=\"margin-top:0\">⚠ Very low — only ${r} days left. Contact your health worker now.<\/div>`\n    :s==='low'\n    ?`<div class=\"med-alert warn\" style=\"margin-top:0\">⚠ Getting low — about ${r} days remaining. Schedule a pickup.<\/div>`\n    :`<div class=\"med-alert ok\" style=\"margin-top:0\">✓ You have enough medication for ${r!==null?Math.floor(r\/7):'?'} more weeks.<\/div>`;\n\n  document.getElementById('pt-content').innerHTML=`\n    <div class=\"pt-card\">\n      <h2>My Treatment<\/h2>\n      <div class=\"pt-row\"><span class=\"pt-row-key\">Current Phase<\/span>\n        <span class=\"pill ${ph==='Intensive'?'phase1':ph==='Continuation'?'phase2':'pdone'}\">${ph}<\/span><\/div>\n      <div class=\"pt-row\"><span class=\"pt-row-key\">Current Medication<\/span><span class=\"pt-row-val\" style=\"font-family:var(--mono)\">${currentDrug(pt)}<\/span><\/div>\n      <div class=\"pt-row\"><span class=\"pt-row-key\">Treatment Started<\/span><span class=\"pt-row-val\">${fmtDate(pt.startDate)}<\/span><\/div>\n      <div class=\"pt-row\"><span class=\"pt-row-key\">Continuation Starts<\/span><span class=\"pt-row-val\">${fmtDate(contDate)}<\/span><\/div>\n      <div class=\"pt-row\"><span class=\"pt-row-key\">Treatment Ends<\/span><span class=\"pt-row-val\">${fmtDate(endDate)}<\/span><\/div>\n      <div class=\"pt-row\"><span class=\"pt-row-key\">Days Remaining<\/span><span class=\"pt-row-val\" style=\"color:var(--accent)\">${dl!==null?dl+' days':'—'}<\/span><\/div>\n    <\/div>\n    <div class=\"pt-card\">\n      <h2>Medication Supply<\/h2>\n      <div class=\"ring-wrap\">\n        <svg class=\"ring-svg\" viewBox=\"0 0 88 88\">\n          <circle class=\"ring-bg\" cx=\"44\" cy=\"44\" r=\"34\"\/>\n          <circle class=\"ring-fill\" cx=\"44\" cy=\"44\" r=\"34\" stroke=\"${ringColor}\" stroke-dasharray=\"${C}\" stroke-dashoffset=\"${offset}\"\/>\n          <text class=\"ring-text\" x=\"44\" y=\"44\">${pct}%<\/text>\n        <\/svg>\n        <div class=\"ring-info\">\n          <h3>${rem} tablets<\/h3>\n          <p>of ${tot} total<\/p>\n          ${r!==null?`<div class=\"wk\">${Math.floor(r\/7)} weeks · ${r} days<\/div>`:''}\n        <\/div>\n      <\/div>\n      <div style=\"margin-top:12px\">${alertMsg}<\/div>\n    <\/div>\n    <div class=\"pt-card\">\n      <h2>6-Month Treatment Progress<\/h2>\n      <div class=\"pt-tl-track\">\n        <div class=\"pt-tl-p1\" style=\"width:${iPct*(INTENSIVE_DAYS\/TOTAL_DAYS)}%\"><\/div>\n        <div class=\"pt-tl-p2\" style=\"width:${cPct*((TOTAL_DAYS-INTENSIVE_DAYS)\/TOTAL_DAYS)}%\"><\/div>\n      <\/div>\n      <div class=\"pt-tl-labels\"><span>Start<\/span><span>Month 2<\/span><span>Month 4<\/span><span>Month 6<\/span><\/div>\n      <div class=\"pt-phase-blocks\">\n        <div class=\"pt-phase-block\" style=\"background:var(--phase1-light)\">\n          <div class=\"pb-label\" style=\"color:#92400e\">Intensive<\/div>\n          <div class=\"pb-med\" style=\"color:var(--phase1)\">${pt.drug1||'RHZE'}<\/div>\n          <div class=\"pb-sub\" style=\"color:#92400e\">${iPct}% complete<\/div>\n        <\/div>\n        <div class=\"pt-phase-block\" style=\"background:var(--phase2-light)\">\n          <div class=\"pb-label\" style=\"color:#1e40af\">Continuation<\/div>\n",
  "stderr" : ""
}          <div class="pb-med" style="color:var(--phase2)">${pt.drug2||'RH'}</div>
          <div class="pb-sub" style="color:#1e40af">${cPct}% complete</div>
        </div>
      </div>
    </div>
    ${pt.notes?`<div class="pt-card"><h2>Notes from Health Worker</h2><p style="font-size:13px;color:var(--text2);line-height:1.7">${pt.notes}</p></div>`:''}
  `;
}

document.getElementById('modal-overlay').addEventListener('click',function(e){if(e.target===this)closeModal();});
</script>
</body>
</html>
